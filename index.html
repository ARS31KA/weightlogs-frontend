<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>体重・体脂肪率グラフ (WeightLogs)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <!-- BEGIN: Token Receiver -->
    <script>
      (function () {
        const qs = new URLSearchParams(location.search);
        const hs = new URLSearchParams(location.hash.slice(1));
        const tok =
          qs.get("id_token") ||
          qs.get("token") ||
          hs.get("id_token") ||
          hs.get("token");
        if (tok) {
          localStorage.setItem("idToken", tok);
          try {
            history.replaceState({}, "", location.pathname);
          } catch (e) {}
        }

        window.getAuthHeader = function () {
          const t = localStorage.getItem("idToken");
          if (!t)
            throw new Error(
              "IdToken が未入力です（A の認証後にURLで受け取るか、貼り付けで保存してください）"
            );
          return { Authorization: "Bearer " + t };
        };
      })();
    </script>
    <!-- END: Token Receiver -->

    <style>
      body {
        font-family: "Segoe UI", Helvetica, Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #111827, #1f2937);
        color: #e5e7eb;
      }
      h1 {
        text-align: center;
        color: #60a5fa;
      }
      .card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        margin-bottom: 16px;
      }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
      }
      button:hover {
        background: #2563eb;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid #3b82f6;
      }
      .small {
        font-size: 14px;
        color: #9ca3af;
      }
      input {
        font-size: 16px;
        padding: 6px;
        border-radius: 6px;
        border: none;
        flex: 1;
      }
      canvas {
        width: 100%;
        height: 380px;
      }
      pre {
        background: rgba(255, 255, 255, 0.07);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <h1>体重・体脂肪率グラフ</h1>

    <!-- 🔐 トークン管理UI（非表示方式B） -->
    <div class="card">
      <div class="toolbar">
        <span id="tokenStatus" class="small">—</span>
        <div style="display:flex; gap:6px;">
          <button id="showPaste">トークン貼り付け</button>
          <button id="clearToken" class="btn-ghost">トークン消去</button>
        </div>
      </div>

      <div id="paste-token" style="display:none; margin-top:10px;">
        <input id="token-input" placeholder="IdToken をここに貼り付け" style="width:60%">
        <button id="doSavePaste">保存</button>
      </div>
    </div>

    <!-- 📅 操作UI -->
    <div class="card">
      <div class="toolbar">
        <label>期間 from:</label>
        <input id="from" type="datetime-local" />
        <button id="load">読み込み（GET）</button>
        <button id="add">今日のデータ追加（POST）</button>
      </div>
    </div>

    <canvas id="chart"></canvas>
    <pre id="log"></pre>

    <script>
      const BASE_URL =
        "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";

      const $from = document.getElementById("from");
      const $log = document.getElementById("log");
      let chart;

      function fmtLocal(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function log(msg) {
        $log.textContent = msg;
      }

      // 🎨 Chart.js 初期化
      const ctx = document.getElementById("chart");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "体重 (kg)",
              data: [],
              borderColor: "#60a5fa",
              backgroundColor: "rgba(96,165,250,0.2)",
              tension: 0.3,
              yAxisID: "y1",
            },
            {
              label: "体脂肪率 (%)",
              data: [],
              borderColor: "#f472b6",
              borderDash: [5, 4],
              tension: 0.3,
              yAxisID: "y2",
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "日時 (ローカル)" } },
            y1: {
              type: "linear",
              position: "left",
              title: { display: true, text: "体重 (kg)" },
              suggestedMin: 40,
              suggestedMax: 90,
            },
            y2: {
              type: "linear",
              position: "right",
              title: { display: true, text: "体脂肪率 (%)" },
              suggestedMin: 10,
              suggestedMax: 40,
              grid: { drawOnChartArea: false },
            },
          },
        },
      });

      // 📦 LocalStorage 状況更新
      (function initTokenUI() {
        const has = !!localStorage.getItem("idToken");
        document.getElementById("tokenStatus").textContent = has
          ? "✅ トークン保存済み"
          : "❌ トークン未保存";
        document.getElementById("paste-token").style.display = has
          ? "none"
          : "flex";
      })();

      document.getElementById("showPaste").onclick = () => {
        document.getElementById("paste-token").style.display = "flex";
      };

      document.getElementById("doSavePaste").onclick = () => {
        const t = document.getElementById("token-input").value.trim();
        if (!t) return alert("IdToken を入力してください");
        localStorage.setItem("idToken", t);
        alert("保存しました");
        document.getElementById("tokenStatus").textContent = "✅ トークン保存済み";
        document.getElementById("paste-token").style.display = "none";
      };

      document.getElementById("clearToken").onclick = () => {
        localStorage.removeItem("idToken");
        alert("消去しました");
        document.getElementById("tokenStatus").textContent = "❌ トークン未保存";
        document.getElementById("paste-token").style.display = "flex";
      };

      // 🧮 データ取得
      async function fetchAndDraw() {
        try {
          const fromVal = $from.value;
          const fromISO = fromVal
            ? new Date(fromVal).toISOString()
            : "1970-01-01T00:00:00Z";
          const url = `${BASE_URL}/weights?from=${encodeURIComponent(fromISO)}`;
          const res = await fetch(url, { headers: getAuthHeader() });
          const text = await res.text();
          if (!res.ok) throw new Error(`GET 失敗: ${res.status} ${text}`);
          const json = JSON.parse(text);
          const items = (json.items || []).sort((a, b) =>
            a.loggedAt.localeCompare(b.loggedAt)
          );

          chart.data.labels = items.map((x) => fmtLocal(x.loggedAt));
          chart.data.datasets[0].data = items.map((x) => Number(x.weightKg));
          chart.data.datasets[1].data = items.map((x) =>
            x.bodyFat !== undefined && x.bodyFat !== null
              ? Number(x.bodyFat)
              : null
          );
          chart.update();

          log(
            `GET OK (${items.length}件)\n` +
              JSON.stringify(items.slice(-5), null, 2)
          );
        } catch (e) {
          console.error(e);
          alert(e.message || e);
          log(e.message || e);
        }
      }

      // ➕ データ追加
      async function addWeight() {
        try {
          const input = prompt("今日の体重(kg)を入力:", "62.8");
          if (input == null) return;
          const weight = Number(input);
          if (!Number.isFinite(weight)) return alert("数値を入力してください");

          const fatInput = prompt("体脂肪率(%)を入力（任意）:", "20.5");
          const bodyFat = fatInput ? Number(fatInput) : null;

          const res = await fetch(`${BASE_URL}/weights`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeader(),
            },
            body: JSON.stringify({ weightKg: weight, bodyFat }),
          });

          const text = await res.text();
          if (!res.ok) throw new Error(`POST 失敗: ${res.status} ${text}`);
          alert("保存しました！");
          log(`POST OK\n${text}`);
          await fetchAndDraw();
        } catch (e) {
          console.error(e);
          alert(e.message || e);
          log(e.message || e);
        }
      }

      document.getElementById("load").onclick = fetchAndDraw;
      document.getElementById("add").onclick = addWeight;
    </script>
  </body>
</html>
