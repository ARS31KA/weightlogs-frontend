<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>FitSnap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- BEGIN: Token Receiver -->
    <script>
    (function(){
      const qs=new URLSearchParams(location.search);
      const hs=new URLSearchParams(location.hash.slice(1));
      const tok=qs.get('id_token')||qs.get('token')||hs.get('id_token')||hs.get('token');
      if(tok){
        localStorage.setItem('idToken', tok);
        try{history.replaceState({}, "", location.pathname);}catch(e){}
      }
      window.getAuthHeader=function(){
        const t=localStorage.getItem('idToken');
        if(!t) throw new Error('IdToken ãŒæœªå…¥åŠ›ã§ã™ï¼ˆURL ã® ?id_token=... ã§æ¸¡ã—ã¦ãã ã•ã„ï¼‰');
        return { Authorization:'Bearer '+t };
      };
    })();
    </script>
    <!-- END: Token Receiver -->

    <script>
    function getSubFromIdToken() {
      const t = localStorage.getItem('idToken');
      if (!t) return null;
      const parts = t.split('.');
      if (parts.length < 2) return null;
      try {
        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
        return payload.sub || null;
      } catch (e) { return null; }
    }
    </script>

    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
      :root{
        --bg0:#f4f7fb; --bg1:#eaf0ff; --card:#ffffff; --text:#0c1b36;
        --muted:#5e6b86; --line:#d6deee; --accent:#2f7cf6; --accent2:#18c3a1;
        --grid:#c9d6ee; --chip:#eff4ff; --fat:#f55ca6; --target:#7b8798;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; padding:28px;
        background:radial-gradient(1200px 600px at 20% -10%, var(--bg1) 0%, var(--bg0) 60%),linear-gradient(180deg, var(--bg1), var(--bg0));
        color:var(--text);
        font:16px/1.7 system-ui, Segoe UI, Helvetica, Arial;
      }
      .container{max-width:1080px;margin:0 auto}
      header.apphead{display:flex; align-items:center; gap:14px; margin-bottom:16px;}
      .logo{
        width:48px; height:48px; border-radius:14px;
        background: conic-gradient(from 210deg,var(--accent),#7f9cfb,var(--accent2));
        box-shadow:0 10px 22px rgba(47,124,246,.25);
        display:grid; place-items:center; color:#fff; font-weight:900;
        font-size:18px;
      }
      h1{margin:0; font-size:28px; font-weight:900;}
      .brand-accent{background:linear-gradient(90deg,var(--accent),var(--accent2));
        -webkit-background-clip:text;background-clip:text;color:transparent}
      .card{
        background:var(--card); border:1px solid var(--line); border-radius:16px;
        box-shadow:0 8px 20px rgba(17,32,64,.06); padding:16px;
      }
      .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      label{color:var(--muted); font-size:13px}
      input,select{
        background:#f8fbff; color:#0c1b36;
        border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none;
      }
      input[type="number"]{width:120px}
      input[type="datetime-local"]{min-width:240px}
      .btn{
        border:1px solid var(--line); background:#f8fbff; color:#0c1b36;
        padding:10px 14px; border-radius:12px; cursor:pointer;
        transition:.15s transform,.15s background,.15s border-color,.15s filter;
      }
      .btn:hover{transform:translateY(-1px); border-color:#b7c6de; background:#ffffff}
      .btn-primary{background: linear-gradient(90deg, var(--accent), var(--accent2));
        border-color:transparent; color:#fff;}
      .btn-primary:hover{filter:brightness(1.06)}
      .btn-danger{ border-color:#ffc9c9; background:#fff4f4; color:#b00020; } /* logoutç”¨ */
      .btn-danger:hover{ background:#ffffff; border-color:#ff9c9c; }
      .chartbox{position:relative;width:100%;height:520px;border:1px dashed var(--line);
        border-radius:12px;background:var(--chip)}
      .chartbox canvas{position:absolute;inset:0;width:100%!important;height:100%!important;display:block}
      .small{font-size:13px; color:var(--muted)}

      /* ã‚»ãƒªãƒ•ï¼ã‚­ãƒ£ãƒ© */
      .coach-row{display:flex; gap:14px; align-items:flex-start}
      .avatar{
        width:64px;height:64px;border-radius:50%;
        display:grid;place-items:center;font-size:30px;background:#fff;
        border:1px solid var(--line); box-shadow:0 6px 16px rgba(17,32,64,.07);
      }
      .bubble{
        position:relative; background:#fff; border:1px solid var(--line);
        border-radius:14px; padding:12px 14px; box-shadow:0 6px 18px rgba(17,32,64,.08);
        min-height:48px; display:flex; align-items:center; font-weight:600;
      }
      .bubble::before{
        content:""; position:absolute; left:-10px; top:18px; width:0; height:0;
        border-top:10px solid transparent; border-bottom:10px solid transparent;
        border-right:10px solid #fff; filter:drop-shadow(0 0 0 var(--line));
      }
      .toast{position:fixed; right:20px; bottom:20px; z-index:9999; background:#fff;
        border:1px solid var(--line); color:#0c1b36; padding:12px 14px; border-radius:12px;
        box-shadow:0 6px 18px rgba(17,32,64,.12); display:none; max-width:380px}

      #log{display:none}
      .hr{height:1px;background:var(--line);margin:8px 0 12px}
      .caps{font-size:12px;letter-spacing:.2px;color:var(--muted)}
    </style>
  </head>
  <body>
    <div class="container">
      <header class="apphead">
        <div class="logo">FS</div>
        <div style="flex:1 1 auto"><h1><span class="brand-accent">FitSnap</span></h1></div>
        <button id="logout" class="btn btn-danger" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </header>

      <!-- æœŸé–“ & ãƒ‡ãƒ¼ã‚¿æ“ä½œ -->
      <div class="card" style="margin-bottom:14px">
        <div class="toolbar" style="align-items:center">
          <div style="display:flex;gap:8px;align-items:center;">
            <label>æœŸé–“ from</label>
            <input id="from" type="datetime-local">
          </div>
          <button id="load" class="btn">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</button>
          <button id="add" class="btn btn-primary">ä»Šæ—¥ã®ä½“é‡ã‚’è¿½åŠ </button>
          <span id="last-updated" class="small" style="margin-left:auto">â€”</span>
        </div>
      </div>

      <!-- ç›®æ¨™ & å£èª¿/ã‚­ãƒ£ãƒ© -->
      <div class="card" style="margin-bottom:14px">
        <div class="toolbar">
          <div style="display:flex;gap:8px;align-items:center;">
            <label>ç›®æ¨™ä½“é‡</label>
            <input id="target" type="number" step="0.1" placeholder="ä¾‹: 62.0"> <span class="small">kg</span>
            <button id="saveTarget" class="btn">ä¿å­˜</button>
          </div>
          <div class="hr" style="flex-basis:100%"></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label>å£èª¿</label>
            <select id="mode">
              <option value="encourage">é¼“èˆï¼ˆã‚„ã•ã—ã‚ï¼‰</option>
              <option value="taunt">ç…½ã‚Šï¼ˆå³ã—ã‚ï¼‰</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label>ã‚­ãƒ£ãƒ©</label>
            <select id="character">
              <option value="coach">ğŸ”¥ ã‚³ãƒ¼ãƒ</option>
              <option value="mascot">ğŸ£ ãƒã‚¹ã‚³ãƒƒãƒˆ</option>
              <option value="samurai">ğŸ—¡ï¸ ã‚µãƒ ãƒ©ã‚¤</option>
            </select>
          </div>
          <button id="testLine" class="btn">ã‚»ãƒªãƒ•ã‚’ãƒ†ã‚¹ãƒˆ</button>
          <span class="small" id="goalHint" style="margin-left:auto">ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ç‚¹ç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>
        </div>
        <div style="height:10px"></div>
        <div class="coach-row">
          <div id="avatar" class="avatar">ğŸ”¥</div>
          <div id="bubble" class="bubble">ã“ã“ã«ã‚­ãƒ£ãƒ©ã®ã‚»ãƒªãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:10px">
        <div class="chartbox"><canvas id="chart"></canvas></div>
      </div>

      <pre id="log"></pre>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ====== è¨­å®š ======
      const BASE_URL = "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";
      const SUMMARY_URL = "https://9mqisvjaqf.execute-api.us-east-1.amazonaws.com/metrics/summary";
      const LOGOUT_URL = "https://face-login-1013-921500610446.s3.us-east-1.amazonaws.com/index.html";

      // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
      const pad = n=>String(n).padStart(2,"0");
      const fmtLocal=iso=>{
        const d=new Date(iso); if(isNaN(d)) return iso;
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };
      const toast=(msg,type="ok",ms=2600)=>{
        const t=document.getElementById("toast");
        t.className=`toast ${type}`;
        t.textContent=String(msg);
        t.style.display='block';
        clearTimeout(t._t);
        t._t=setTimeout(()=>t.style.display='none',ms);
      };
      const log=msg=>document.getElementById("log").textContent=String(msg);
      const setBusy=(b,ids=["load","add","saveTarget","testLine"])=>{
        ids.forEach(id=>{
          const el=document.getElementById(id);
          el.disabled=b; el.style.opacity=b?0.6:1; el.style.cursor=b?"wait":"pointer";
        });
      };

      // localStorage keys
      const LS_TARGET="fs_targetWeight";
      const LS_MODE="fs_motivationMode";
      const LS_CHAR="fs_character";

      // ç›´è¿‘1ã‹æœˆã‚’æ—¢å®š
      (()=>{
        const d=new Date(); d.setMonth(d.getMonth()-1);
        const local=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
        document.getElementById("from").value=local;
      })();

      // ====== ä½“é‡è»¸ãƒ¬ãƒ³ã‚¸ ======
      function calcWeightRange(weights){
        if(!weights || weights.length===0) return {min:40, max:90};
        const wmin = Math.min(...weights);
        const wmax = Math.max(...weights);
        const padKg = 2;
        const lo = Math.floor((wmin - padKg)/5)*5;
        const hi = Math.ceil((wmax + padKg)/5)*5;
        return { min: Math.max(30, lo), max: Math.min(150, hi) };
      }

      // ====== Chart.js åˆæœŸåŒ– ======
      let chart,lastItems=[];
      function initChart(){
        const ctx=document.getElementById("chart").getContext('2d');
        const getCss=varname=>getComputedStyle(document.documentElement).getPropertyValue(varname).trim();
        const accent=getCss('--accent');
        const grid=getCss('--grid');
        const fatCol=getCss('--fat');
        const targetCol=getCss('--target');

        chart=new Chart(ctx,{
          type:"line",
          data:{labels:[],datasets:[
            {label:"ä½“é‡ (kg)",yAxisID:'yWeight',data:[],tension:0.2,borderWidth:3,pointRadius:4,borderColor:accent,
             backgroundColor:"rgba(47,124,246,0.10)",fill:true,
             datalabels:{
               color:"#0c1b36",
               align:'right', anchor:'end', offset:6, clip:false,
               formatter:v=>`${Number(v).toFixed(1)} kg`,
               font:{ size:12, weight:'600' },
               display:true
             }},
            {label:"ä½“è„‚è‚ªç‡ (%)",yAxisID:'yFat',data:[],tension:0.25,borderWidth:4,pointRadius:5,borderColor:fatCol,
             backgroundColor:"rgba(245,92,166,0.15)",fill:false,
             datalabels:{
               color:fatCol,
               align:'right', anchor:'end', offset:6, clip:false,
               formatter:v=>`${Number(v).toFixed(1)} %`,
               font:{ size:12, weight:'700' },
               display:true
             }},
            // ç›®æ¨™ãƒ©ã‚¤ãƒ³
            {label:"ç›®æ¨™ (kg)",yAxisID:'yWeight',data:[],tension:0,
             borderWidth:2,pointRadius:0,borderColor:targetCol,borderDash:[6,6],fill:false,
             datalabels:{display:false}}
          ]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{ labels:{ color:"var(--muted)" } },
              tooltip:{
                enabled:true,
                backgroundColor:"#ffffff",
                borderColor:"#d7dfec",
                borderWidth:1,
                titleColor:"#0c1b36",
                bodyColor:"#334568",
                callbacks:{
                  title:items=>items.length?items[0].label:"",
                  label:ctx=>{
                    const y=Number(ctx.parsed.y);
                    const id=ctx.datasetIndex;
                    if(id===1) return ` ä½“è„‚è‚ªç‡: ${y.toFixed(1)} %`;
                    if(id===2) return ` ç›®æ¨™: ${y.toFixed(1)} kg`;
                    return ` ä½“é‡: ${y.toFixed(1)} kg`;
                  }
                }
              }
            },
            scales:{
              x:{
                grid:{color:grid},ticks:{color:"var(--muted)"},
                title:{display:true,text:"æ—¥æ™‚ (ãƒ­ãƒ¼ã‚«ãƒ«)",color:"var(--muted)"}
              },
              yWeight:{
                position:'left',
                grid:{color:grid},ticks:{color:"var(--muted)"},
                suggestedMin:40,suggestedMax:90,
                title:{display:true,text:"ä½“é‡ (kg)",color:"var(--muted)"}
              },
              yFat:{
                position:'right',
                grid:{drawOnChartArea:false},
                ticks:{color:"var(--muted)",callback:v=>`${v}%`},
                min:5,max:45,
                title:{display:true,text:"ä½“è„‚è‚ªç‡ (%)",color:"var(--muted)"}
              }
            }
          },
          plugins:[ChartDataLabels]
        });

        // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‰Šé™¤
        const canvas=ctx.canvas;
        canvas.addEventListener('dblclick', async (evt)=>{
          try{
            const points=chart.getElementsAtEventForMode(evt,'nearest',{intersect:false,axis:'x'},true);
            if(!points || points.length===0) return;
            const index=points[0].index;
            const target=lastItems[index];
            if(!target || !target.loggedAt) return;

            const dateStr=fmtLocal(target.loggedAt);
            const ok=confirm(`ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\næ—¥æ™‚: ${dateStr}\nä½“é‡: ${target.weightKg} kg`);
            if(!ok) return;

            const url=`${BASE_URL}/weights?loggedAt=${encodeURIComponent(target.loggedAt)}`;
            const headers=(()=>{try{return window.getAuthHeader();}catch{ return {}; }})();
            const res=await fetch(url,{method:'DELETE',headers});
            const text=await res.text();
            if(!res.ok) throw new Error(`DELETE å¤±æ•—: ${res.status} ${text}`);

            toast("å‰Šé™¤ã—ã¾ã—ãŸ");
            await fetchAndDraw();
          }catch(e){
            console.error(e);
            toast(e.message||e,"err");
          }
        });
      }

      // ====== /metrics/summary ======
      let profile=null;
      async function fetchSummary(){
        let headers={};
        const sub = getSubFromIdToken();
        if (!sub) throw new Error("idToken ã‹ã‚‰ sub ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        headers['x-fitsnap-sub'] = sub;
        const res=await fetch(SUMMARY_URL,{headers});
        const text=await res.text();
        if(!res.ok) throw new Error(`GET /metrics/summary å¤±æ•—: ${res.status} ${text}`);
        const data=JSON.parse(text);
        if(!data || typeof data!=='object' || !data.profile || !Array.isArray(data.series))
          throw new Error("API payload shape invalid");
        return data;
      }

      // ====== ã‚°ãƒ©ãƒ•æç”» ======
      function readTarget(){
        const v = Number(localStorage.getItem(LS_TARGET));
        return Number.isFinite(v)? v : null;
      }
      function writeTarget(v){
        if(Number.isFinite(v)){ localStorage.setItem(LS_TARGET,String(v)); }
      }

      async function fetchAndDraw(){
        try{
          setBusy(true);
          const data=await fetchSummary();
          profile=data.profile||null;

          const fromVal=document.getElementById("from").value;
          const fromISO=fromVal?new Date(fromVal).toISOString():null;
          let series=Array.isArray(data.series)?data.series.slice():[];
          if(fromISO){
            series=series.filter(p=>{
              const d=/^\d{8}$/.test(p.date)?new Date(`${p.date.slice(0,4)}-${p.date.slice(4,6)}-${p.date.slice(6,8)}T00:00:00Z`):new Date(p.date);
              return d>=new Date(fromISO);
            });
          }

          lastItems=series.map(p=>({loggedAt:p.date,weightKg:p.weight}));

          const weights=series.map(p=>Number(p.weight));
          const fats=series.map(p=>Number(p.bodyFat));
          chart.data.labels=series.map(p=>fmtLocal(p.date));
          chart.data.datasets[0].data=weights;
          chart.data.datasets[1].data=fats;

          // ç›®æ¨™ãƒ©ã‚¤ãƒ³
          const tg = readTarget();
          const targetArr = (tg && chart.data.labels.length)
            ? new Array(chart.data.labels.length).fill(tg)
            : [];
          chart.data.datasets[2].data = targetArr;
          document.getElementById('goalHint').textContent = tg ? `ç›®æ¨™: ${tg.toFixed(1)} kg` : 'ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ç‚¹ç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™';

          // ä½“é‡è»¸ãƒ¬ãƒ³ã‚¸
          const {min,max}=calcWeightRange(weights.length?weights.concat(tg||[]):weights);
          chart.options.scales.yWeight.min=min;
          chart.options.scales.yWeight.max=max;

          chart.update('none');
          document.getElementById('last-updated').textContent="æœ€çµ‚æ›´æ–°: "+new Date().toLocaleString();

          if(series.length===0){log("ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“");toast("ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“","ok");}
          else{log(`OK (${series.length}ä»¶)`);toast("ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã—ã¾ã—ãŸ");}
        }catch(e){console.error(e);log(e.message||e);toast(e.message||e,"err");}
        finally{setBusy(false);}
      }

      // ====== ã‚»ãƒªãƒ•ç”Ÿæˆ ======
      const characters = {
        coach: {icon:"ğŸ”¥", name:"ã‚³ãƒ¼ãƒ"},
        mascot:{icon:"ğŸ£", name:"ãƒã‚¹ã‚³ãƒƒãƒˆ"},
        samurai:{icon:"ğŸ—¡ï¸", name:"ã‚µãƒ ãƒ©ã‚¤"}
      };

      function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

      function buildLine({weight, target, mode, achieved, diff}){
        const d = Math.abs(diff).toFixed(1);
        const c = document.getElementById("character").value;

        const praise = {
          coach: [
            `ã‚„ã£ãŸãªï¼ç›®æ¨™ã‚¯ãƒªã‚¢ã ï¼ã“ã®å‹¢ã„ã€æ­¢ã‚ã‚‹ãªã‚ˆï¼`,
            `å®Œç’§ã ï¼ä»Šæ—¥ã®è‡ªåˆ†ã«æ‹æ‰‹ï¼æ¬¡ã¯ã‚­ãƒ¼ãƒ—ã ï¼`
          ],
          mascot: [
            `ã™ã”ãƒ¼ã„ï¼ç›®æ¨™é”æˆã ã‚ˆï¼ãˆã‚‰ã„ãˆã‚‰ã„ï¼`,
            `ã‚„ã£ãŸã­ï¼ã‚³ãƒ„ã‚³ãƒ„ã®å‹åˆ©ã ã‚ˆï¼`
          ],
          samurai: [
            `è¦‹äº‹ã€ç›®æ¨™æˆå°±ã€‚ä¸æ–­ã®ç¨½å¤ã®è³œç‰©ãªã‚Šã€‚`,
            `èª‰ã‚Œé«˜ã—ã€‚å¿—ã€ç¢ºã‹ã«é€šã˜ãŸã€‚`
          ]
        };

        const encourage = {
          coach: [
            `ã‚ã¨ ${d}kgï¼ç„¦ã‚‹ãªã€ä»Šã®ãƒšãƒ¼ã‚¹ã§ã„ã‘ã‚‹ï¼`,
            `å¤§ä¸ˆå¤«ã€${d}kgãªã‚“ã¦ã™ãã ã€‚æ°´åˆ†ã¨ç¡çœ ã€è¦‹ç›´ã—ã¦ã„ã“ã†ï¼`
          ],
          mascot: [
            `ã‚ã¨ ${d}kgã ã‚ˆã€‚ã„ã£ã—ã‚‡ã«ãŒã‚“ã°ã‚â€¦ï¼`,
            `ã‚‚ã†ã¡ã‚‡ã£ã¨ï¼ã‚¹ãƒˆãƒ¬ãƒƒãƒã—ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã‚ˆï¼`
          ],
          samurai: [
            `æ®‹ã‚Š ${d}kgã€‚å¿ƒä¹±ã•ãšã€ç­–ã‚’é‡ã­ã‚ˆã€‚`,
            `é“åŠã°ã€‚é£Ÿã¨çœ ã€å¾‹ã—ã€æ­©ã¿ã‚’æ­¢ã‚ã‚‹ãªã€‚`
          ]
        };

        const taunt = {
          coach: [
            `æœªé”ã ï¼ã‚ã¨ ${d}kgã€‚è¨€ã„è¨³ã¯ã‚´ãƒŸç®±ã«æ¨ã¦ã‚ã€å‹•ã‘ï¼`,
            `ã¾ã ã„ã‘ã‚‹ã ã‚ï¼Ÿ ${d}kgã”ã¨ãã§æ­¢ã¾ã‚‹ãªï¼`
          ],
          mascot: [
            `ã‚ã‚Œã‚Œã€œï¼Ÿç›®æ¨™ã¾ã ã ã‚ˆï¼Ÿã‚ã¨ ${d}kgã€ãŒã‚“ã°ã‚Œã€œï¼`,
            `ã‚€ã‚€ã£â€¦ä»Šæ—¥ã¯æƒœã—ã„ï¼æ˜æ—¥ã“ãæ±ºã‚ã‚ˆï¼`
          ],
          samurai: [
            `æœªã ç›®æ¨™ã«è‡³ã‚‰ãšã€‚æ€ ã‚Šã‚ã‚‰ã°åˆƒã€éˆã‚‹ã®ã¿ã€‚æ®‹ã‚Š ${d}kgã€‚`,
            `ä¿®è¡ŒãŒè¶³ã‚Šã¬ã€‚è¦šæ‚Ÿã‚’ç ”ãæ¾„ã¾ã›ã€ã‚ã¨ ${d}kgã ã€‚`
          ]
        };

        if(achieved){
          return pick(praise[c]);
        }else{
          return (mode==="taunt") ? pick(taunt[c]) : pick(encourage[c]);
        }
      }

      function renderSpeech(line){
        const charKey = document.getElementById("character").value;
        const {icon,name}=characters[charKey]||characters.coach;
        document.getElementById("avatar").textContent = icon;
        document.getElementById("bubble").textContent = line || "â€¦â€¦";
      }

      function getMode(){ return (localStorage.getItem(LS_MODE)||"encourage"); }
      function setMode(v){ localStorage.setItem(LS_MODE, v); }
      function getChar(){ return (localStorage.getItem(LS_CHAR)||"coach"); }
      function setChar(v){ localStorage.setItem(LS_CHAR, v); }

      // ====== ä»Šæ—¥ã®ä½“é‡è¿½åŠ  ======
      async function addWeight(){
        try{
          setBusy(true,["add"]);
          const input=prompt("ä»Šæ—¥ã®ä½“é‡(kg)ã‚’å…¥åŠ›:","62.8");
          if(input==null)return;
          const weight=Number(input);
          if(!Number.isFinite(weight))return toast("æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","err");

          const res=await fetch(`${BASE_URL}/weights`,{
            method:"POST",
            headers:{"Content-Type":"application/json",...window.getAuthHeader()},
            body:JSON.stringify({weightKg:weight}),
          });
          const text=await res.text();
          if(!res.ok)throw new Error(`POST å¤±æ•—: ${res.status} ${text}`);

          log(`POST OK\n${text}`);toast("è¿½åŠ ã—ã¾ã—ãŸ");

          // ç›®æ¨™æ¯”è¼ƒ â†’ ã‚»ãƒªãƒ•
          const target = readTarget();
          if(target){
            const achieved = (weight <= target);
            const diff = weight - target; // æ­£:è¶…é, è² :é”æˆä½™è£•
            const line = buildLine({weight, target, mode:getMode(), achieved, diff});
            renderSpeech(line);
          }else{
            renderSpeech("ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ã‚³ãƒ¼ãƒãŒã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‚ˆï¼");
          }

          await fetchAndDraw();
        }catch(e){console.error(e);log(e.message||e);toast(e.message||e,"err");}
        finally{setBusy(false,["add"]);}
      }

      // ====== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ======
      function renderLoggedOut(){
        document.body.innerHTML = `
          <div style="min-height:100dvh;display:grid;place-items:center;background:linear-gradient(180deg,#f8fbff,#f3f6fb)">
            <div style="background:#fff;border:1px solid #dfe7f4;border-radius:16px;padding:28px 24px;box-shadow:0 8px 24px rgba(17,32,64,.08);max-width:460px;text-align:center">
              <div style="font-size:22px;font-weight:800;letter-spacing:.3px;margin-bottom:6px">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†</div>
              <div style="color:#5e6b86;margin-bottom:18px">ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</div>
              <button onclick="location.reload()" class="btn" style="padding:10px 16px">æˆ»ã‚‹</button>
            </div>
          </div>
        `;
      }
      function doLogout(){
        try{ localStorage.removeItem('idToken'); }catch(e){}
        if (LOGOUT_URL && typeof LOGOUT_URL === 'string' && LOGOUT_URL.trim() !== "") {
          location.href = LOGOUT_URL;
        } else {
          renderLoggedOut();
        }
      }

      // ====== åˆæœŸåŒ– ======
      function syncUIFromStorage(){
        const t = readTarget();
        if(t){ document.getElementById("target").value = t; }
        const mode = getMode();
        const char = getChar();
        document.getElementById("mode").value = mode;
        document.getElementById("character").value = char;
        // åˆæœŸã®é¡”ã¨ã‚»ãƒªãƒ•
        renderSpeech("ä»Šæ—¥ã‚‚è¨˜éŒ²ã—ã¦ã„ã“ã†ï¼");
      }

      function init(){
        initChart();
        syncUIFromStorage();

        document.getElementById("load").addEventListener("click",fetchAndDraw);
        document.getElementById("add").addEventListener("click",addWeight);
        document.getElementById("logout").addEventListener("click", doLogout);

        document.getElementById("saveTarget").addEventListener("click",()=>{
          const v = Number(document.getElementById("target").value);
          if(!Number.isFinite(v)){ toast("ç›®æ¨™ä½“é‡ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„","err"); return; }
          writeTarget(v);
          toast("ç›®æ¨™ä½“é‡ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
          fetchAndDraw();
        });

        document.getElementById("mode").addEventListener("change",(e)=>{
          setMode(e.target.value);
          toast("å£èª¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        });
        document.getElementById("character").addEventListener("change",(e)=>{
          setChar(e.target.value);
          // é¡”ã‚’ã™ãåæ˜ 
          const {icon}=characters[e.target.value]||characters.coach;
          document.getElementById("avatar").textContent = icon;
        });

        document.getElementById("testLine").addEventListener("click",()=>{
          const t = readTarget();
          if(!t){ toast("ã¾ãšç›®æ¨™ä½“é‡ã‚’è¨­å®šã—ã¦ãã ã•ã„","err"); return; }
          // ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ or ä»®ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
          const last = lastItems[lastItems.length-1];
          const weight = last? Number(last.weightKg) : t + 0.8; // ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã‘ã‚Œã°æœªé”ã£ã½ã
          const achieved = (weight <= t);
          const diff = weight - t;
          const line = buildLine({weight, target:t, mode:getMode(), achieved, diff});
          renderSpeech(line);
        });

        (async()=>{try{await fetchAndDraw();}catch(e){toast(e.message||e,"err");}})();
      }
      init();
    </script>
  </body>
</html>
