
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>FitSnap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- BEGIN: Token Receiver -->
    <script>
    (function(){
      const qs=new URLSearchParams(location.search);
      const hs=new URLSearchParams(location.hash.slice(1));
      const tok=qs.get('id_token')||qs.get('token')||hs.get('id_token')||hs.get('token');
      if(tok){
        localStorage.setItem('idToken', tok);
        try{history.replaceState({}, "", location.pathname);}catch(e){}
      }
      window.getAuthHeader=function(){
        const t=localStorage.getItem('idToken');
        if(!t) throw new Error('IdToken が未入力です（URL の ?id_token=... で渡してください）');
        return { Authorization:'Bearer '+t };
      };
    })();
    </script>
    <!-- END: Token Receiver -->

    <!-- ★ sub を idToken から取り出す関数（追加） -->
    <script>
    function getSubFromIdToken() {
      const t = localStorage.getItem('idToken');
      if (!t) return null;
      const parts = t.split('.');
      if (parts.length < 2) return null;
      try {
        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
        return payload.sub || null;
      } catch (e) { return null; }
    }
    </script>

    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
      :root{
        --bg0:#f4f7fb; --bg1:#eaf0ff; --card:#ffffff; --text:#0c1b36;
        --muted:#5e6b86; --line:#d6deee; --accent:#2f7cf6; --accent2:#18c3a1;
        --grid:#c9d6ee; --chip:#eff4ff; --fat:#f55ca6;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; padding:28px;
        background:radial-gradient(1200px 600px at 20% -10%, var(--bg1) 0%, var(--bg0) 60%),linear-gradient(180deg, var(--bg1), var(--bg0));
        color:var(--text);
        font:16px/1.7 system-ui, Segoe UI, Helvetica, Arial;
      }
      .container{max-width:1080px;margin:0 auto}
      header.apphead{display:flex; align-items:center; gap:14px; margin-bottom:16px;}
      .logo{
        width:48px; height:48px; border-radius:14px;
        background: conic-gradient(from 210deg,var(--accent),#7f9cfb,var(--accent2));
        box-shadow:0 10px 22px rgba(47,124,246,.25);
        display:grid; place-items:center; color:#fff; font-weight:900;
        font-size:18px;
      }
      h1{margin:0; font-size:28px; font-weight:900;}
      .brand-accent{background:linear-gradient(90deg,var(--accent),var(--accent2));
        -webkit-background-clip:text;background-clip:text;color:transparent}
      .card{
        background:var(--card); border:1px solid var(--line); border-radius:16px;
        box-shadow:0 8px 20px rgba(17,32,64,.06); padding:16px;
      }
      .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      label{color:var(--muted); font-size:13px}
      input{
        background:#f8fbff; color:#0c1b36;
        border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none;
      }
      input[type="datetime-local"]{min-width:240px}
      .btn{
        border:1px solid var(--line); background:#f8fbff; color:#0c1b36;
        padding:10px 14px; border-radius:12px; cursor:pointer;
        transition:.15s transform,.15s background,.15s border-color,.15s filter;
      }
      .btn:hover{transform:translateY(-1px); border-color:#b7c6de; background:#ffffff}
      .btn-primary{background: linear-gradient(90deg, var(--accent), var(--accent2));
        border-color:transparent; color:#fff;}
      .btn-primary:hover{filter:brightness(1.06)}
      .btn-danger{ border-color:#ffc9c9; background:#fff4f4; color:#b00020; }
      .btn-danger:hover{ background:#ffffff; border-color:#ff9c9c; }
      .chartbox{position:relative;width:100%;height:520px;border:1px dashed var(--line);
        border-radius:12px;background:var(--chip)}
      .chartbox canvas{position:absolute;inset:0;width:100%!important;height:100%!important;display:block}
      .small{font-size:13px; color:var(--muted)}
      .toast{position:fixed; right:20px; bottom:20px; z-index:9999; background:#fff;
        border:1px solid var(--line); color:#0c1b36; padding:12px 14px; border-radius:12px;
        box-shadow:0 6px 18px rgba(17,32,64,.12); display:none; max-width:380px}
      #log{display:none}
    </style>
  </head>
  <body>
    <div class="container">
      <header class="apphead">
        <div class="logo">FS</div>
        <div style="flex:1 1 auto"><h1><span class="brand-accent">FitSnap</span></h1></div>
        <button id="logout" class="btn btn-danger" title="ログアウト">ログアウト</button>
      </header>

      <div class="card" style="margin-bottom:14px">
        <div class="toolbar" style="align-items:center">
          <div style="display:flex;gap:8px;align-items:center;">
            <label>期間 from</label>
            <input id="from" type="datetime-local">
          </div>
          <button id="load" class="btn">グラフを表示</button>
          <button id="add" class="btn btn-primary">今日の体重を追加</button>
          <span id="last-updated" class="small" style="margin-left:auto">—</span>
        </div>
      </div>

      <div class="card" style="margin-bottom:10px">
        <div class="chartbox"><canvas id="chart"></canvas></div>
      </div>

      <pre id="log"></pre>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ====== 設定 ======
      const BASE_URL = "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";
      const SUMMARY_URL = "https://9mqisvjaqf.execute-api.us-east-1.amazonaws.com/metrics/summary";
      const LOGOUT_URL = "https://face-login-1013-921500610446.s3.us-east-1.amazonaws.com/index.html";

      // ====== ユーティリティ ======
      const pad = n=>String(n).padStart(2,"0");
      const fmtLocal=iso=>{
        const d=new Date(iso); if(isNaN(d)) return iso;
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };
      const toast=(msg,type="ok",ms=2600)=>{
        const t=document.getElementById("toast");
        t.className=`toast ${type}`;
        t.textContent=String(msg);
        t.style.display='block';
        clearTimeout(t._t);
        t._t=setTimeout(()=>t.style.display='none',ms);
      };
      const log=msg=>document.getElementById("log").textContent=String(msg);
      const setBusy=(b,ids=["load","add"])=>{
        ids.forEach(id=>{
          const el=document.getElementById(id);
          el.disabled=b; el.style.opacity=b?0.6:1; el.style.cursor=b?"wait":"pointer";
        });
      };

      // 直近1か月を既定
      (()=>{
        const d=new Date(); d.setMonth(d.getMonth()-1);
        const local=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
        document.getElementById("from").value=local;
      })();

      // ====== 体重軸の“ゆるやか可変”レンジ計算 ======
      function calcWeightRange(weights){
        if(!weights || weights.length===0) return {min:40, max:90};
        const wmin = Math.min(...weights);
        const wmax = Math.max(...weights);
        const padKg = 2;
        const lo = Math.floor((wmin - padKg)/5)*5;
        const hi = Math.ceil((wmax + padKg)/5)*5;
        return { min: Math.max(30, lo), max: Math.min(150, hi) };
      }

      // ====== Chart.js 初期化 ======
      let chart,lastItems=[];
      function initChart(){
        const ctx=document.getElementById("chart").getContext('2d');
        const accent=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        const grid=getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
        const fatCol=getComputedStyle(document.documentElement).getPropertyValue('--fat').trim();

        chart=new Chart(ctx,{
          type:"line",
          data:{labels:[],datasets:[
            {label:"体重 (kg)",yAxisID:'yWeight',data:[],tension:0.2,borderWidth:3,pointRadius:4,borderColor:accent,
             backgroundColor:"rgba(47,124,246,0.10)",fill:true,
             datalabels:{
               color:"#0c1b36", align:'right', anchor:'end', offset:6, clip:false,
               formatter:v=>`${Number(v).toFixed(1)} kg`,
               font:{ size:12, weight:'600' }, display:true
             }},
            {label:"体脂肪率 (%)",yAxisID:'yFat',data:[],tension:0.25,borderWidth:4,pointRadius:5,borderColor:fatCol,
             backgroundColor:"rgba(245,92,166,0.15)",fill:false,
             datalabels:{
               color:fatCol, align:'right', anchor:'end', offset:6, clip:false,
               formatter:v=>`${Number(v).toFixed(1)} %`,
               font:{ size:12, weight:'700' }, display:true
             }}
          ]},
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{
              legend:{ labels:{ color:"var(--muted)" } },
              tooltip:{
                enabled:true, backgroundColor:"#ffffff", borderColor:"#d7dfec", borderWidth:1,
                titleColor:"#0c1b36", bodyColor:"#334568", footerColor:"#334568",
                callbacks:{
                  title:items=>items.length?items[0].label:"",
                  label:ctx=>{
                    const y=Number(ctx.parsed.y);
                    return ctx.dataset.yAxisID==='yFat'
                      ? ` 体脂肪率: ${y.toFixed(1)} %`
                      : ` 体重: ${y.toFixed(1)} kg`;
                  }
                }
              }
            },
            scales:{
              x:{
                grid:{color:grid},ticks:{color:"var(--muted)"},
                title:{display:true,text:"日時 (ローカル)",color:"var(--muted)"}
              },
              yWeight:{
                position:'left', grid:{color:grid}, ticks:{color:"var(--muted)"},
                suggestedMin:40, suggestedMax:90,
                title:{display:true,text:"体重 (kg)",color:"var(--muted)"}
              },
              yFat:{
                position:'right', grid:{drawOnChartArea:false},
                ticks:{color:"var(--muted)",callback:v=>`${v}%`},
                min:5, max:45,
                title:{display:true,text:"体脂肪率 (%)",color:"var(--muted)"}
              }
            }
          },
          plugins:[ChartDataLabels]
        });

        // === ダブルクリックで削除（当たり判定を緩く） ===
        const canvas=ctx.canvas;
        canvas.addEventListener('dblclick', async (evt)=>{
          try{
            const points=chart.getElementsAtEventForMode(evt,'nearest',{intersect:false,axis:'x'},true);
            if(!points || points.length===0) return;
            const index=points[0].index;
            const target=lastItems[index];
            if(!target || !target.loggedAt) return;

            const dateStr=fmtLocal(target.loggedAt);
            const ok=confirm(`このデータを削除しますか？\n日時: ${dateStr}\n体重: ${target.weightKg} kg`);
            if(!ok) return;

            const url=`${BASE_URL}/weights?loggedAt=${encodeURIComponent(target.loggedAt)}`;
            const headers=(()=>{try{return window.getAuthHeader();}catch{ return {}; }})();
            const res=await fetch(url,{method:'DELETE',headers});
            const text=await res.text();
            if(!res.ok) throw new Error(`DELETE 失敗: ${res.status} ${text}`);

            toast("削除しました");
            await fetchAndDraw();
          }catch(e){
            console.error(e);
            toast(e.message||e,"err");
          }
        });
      }

      // ====== /metrics/summary を取得 ======
      let profile=null;
      /*async function fetchSummary(){
        // 1) まず Authorization（JWT Authorizer を付けた場合）
        let headers = {};
        try {
          headers = window.getAuthHeader(); // { Authorization: 'Bearer ...' }
        } catch(e) {
          headers = {};
        }
        // 2) Authorizer未設定でも動くように、x-fitsnap-sub を動的付与
        if (!headers.Authorization) {
          const sub = getSubFromIdToken();
          if (!sub) throw new Error("idToken から sub を取得できません。ログイン状態を確認してください。");
          headers['x-fitsnap-sub'] = sub;
        }

        const res=await fetch(SUMMARY_URL,{headers});
        const text=await res.text();
        if(!res.ok) throw new Error(`GET /metrics/summary 失敗: ${res.status} ${text}`);
        const data=JSON.parse(text);
        if(!data || typeof data!=='object' || !data.profile || !Array.isArray(data.series))
          throw new Error("API payload shape invalid");
        return data;
      }:*/
      /*async function fetchSummary(){
      // 1) まず Authorization（JWT Authorizer を付けた場合）
      let headers = {};
      try {
        headers = window.getAuthHeader(); // => { Authorization: 'Bearer <idToken>' }
        console.debug('[summary] using Authorization header');
      } catch (e) {
        headers = {};
      }
    
      // 2) Authorizer未設定でも動くように、idToken から sub を動的付与
      if (!headers.Authorization) {
        const t = localStorage.getItem('idToken');
        if (!t) throw new Error("idToken がありません。ログイン or ?id_token=... でアクセスしてください。");
    
        let sub = null;
        try {
          const payload = JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
          sub = payload.sub;
        } catch(e) {}
        if (!sub) throw new Error("idToken から sub を取り出せませんでした。");
    
        headers['x-fitsnap-sub'] = sub;
        console.debug('[summary] using x-fitsnap-sub header:', sub);
      }*/
      async function fetchSummary(){
        // 1) 可能なら Authorization を使う
        let headers = {};
        let auth = null;
        try {
          const h = window.getAuthHeader();  // Token Receiver が入っていれば使える
          auth = h && h.Authorization;
        } catch(e) {}
      
        // 2) sub を決める（devSub → idToken からの sub → 手入力）
        let sub = null;
        if (!auth) {
          sub = localStorage.getItem('devSub');
          if (!sub) {
            const t = localStorage.getItem('idToken');
            if (t) {
              try {
                const payload = JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
                sub = payload && payload.sub;
              } catch(e) {}
            }
          }
          if (!sub) {
            sub = prompt("ログインしていないようです。開発用として sub を入力してください。");
            if (sub) localStorage.setItem('devSub', sub);
          }
          if (!sub) throw new Error("sub を特定できません（devSub 未保存 & idToken なし）。");
        } else {
          headers.Authorization = auth;
        }
      
        // 3) URL を組み立てて呼ぶ
        const url = auth ? SUMMARY_URL : `${SUMMARY_URL}?sub=${encodeURIComponent(sub)}`;
        console.debug('[summary] GET', url, auth ? '(Authorization)' : '(?sub)');
      
        const res  = await fetch(url, { headers, cache: 'no-store' });
        const text = await res.text();
        if (!res.ok) throw new Error(`GET /metrics/summary 失敗: ${res.status} ${text}`);
        const data = JSON.parse(text);
        if (!data || typeof data!=='object' || !data.profile || !Array.isArray(data.series))
          throw new Error("API payload shape invalid");
        return data;
      }
      
          
      const res = await fetch(SUMMARY_URL, { headers });
      const text = await res.text();
      if (!res.ok) throw new Error(`GET /metrics/summary 失敗: ${res.status} ${text}`);
      const data = JSON.parse(text);
      if (!data || typeof data !== 'object' || !data.profile || !Array.isArray(data.series)) {
        throw new Error("API payload shape invalid");
      }
      return data;
    }

      

      // ====== グラフ描画 ======
      async function fetchAndDraw(){
        try{
          setBusy(true);
          const data=await fetchSummary();
          profile=data.profile||null;

          const fromVal=document.getElementById("from").value;
          const fromISO=fromVal?new Date(fromVal).toISOString():null;
          let series=Array.isArray(data.series)?data.series.slice():[];
          if(fromISO){
            series=series.filter(p=>{
              const d=/^\d{8}$/.test(p.date)?new Date(`${p.date.slice(0,4)}-${p.date.slice(4,6)}-${p.date.slice(6,8)}T00:00:00Z`):new Date(p.date);
              return d>=new Date(fromISO);
            });
          }

          // 削除用に保持
          lastItems=series.map(p=>({loggedAt:p.date,weightKg:p.weight}));

          // データ反映
          const weights=series.map(p=>Number(p.weight));
          const fats=series.map(p=>Number(p.bodyFat));
          chart.data.labels=series.map(p=>fmtLocal(p.date));
          chart.data.datasets[0].data=weights;
          chart.data.datasets[1].data=fats;

          // 体重軸レンジを“ゆるやか可変”で上書き
          const {min,max}=calcWeightRange(weights);
          chart.options.scales.yWeight.min=min;
          chart.options.scales.yWeight.max=max;

          chart.update('none');

          document.getElementById('last-updated').textContent="最終更新: "+new Date().toLocaleString();

          if(series.length===0){log("データはありません");toast("データはありません","ok");}
          else{log(`OK (${series.length}件)`);toast("グラフを更新しました");}
        }catch(e){console.error(e);log(e.message||e);toast(e.message||e,"err");}
        finally{setBusy(false);}
      }

      // ====== POST: 今日の体重追加 ======
      async function addWeight(){
        try{
          setBusy(true,["add"]);
          const input=prompt("今日の体重(kg)を入力:","62.8");
          if(input==null)return;
          const weight=Number(input);
          if(!Number.isFinite(weight))return toast("数値を入力してください","err");
          const res=await fetch(`${BASE_URL}/weights`,{
            method:"POST",
            headers:{"Content-Type":"application/json",...window.getAuthHeader()},
            body:JSON.stringify({weightKg:weight}),
          });
          const text=await res.text();
          if(!res.ok)throw new Error(`POST 失敗: ${res.status} ${text}`);
          log(`POST OK\n${text}`);toast("追加しました");
          await fetchAndDraw();
        }catch(e){console.error(e);log(e.message||e);toast(e.message||e,"err");}
        finally{setBusy(false,["add"]);}
      }

      // ====== ログアウト ======
      function renderLoggedOut(){
        document.body.innerHTML = `
          <div style="min-height:100dvh;display:grid;place-items:center;background:linear-gradient(180deg,#f8fbff,#f3f6fb)">
            <div style="background:#fff;border:1px solid #dfe7f4;border-radius:16px;padding:28px 24px;box-shadow:0 8px 24px rgba(17,32,64,.08);max-width:460px;text-align:center">
              <div style="font-size:22px;font-weight:800;letter-spacing:.3px;margin-bottom:6px">ログアウト完了</div>
              <div style="color:#5e6b86;margin-bottom:18px">ご利用ありがとうございました。</div>
              <button onclick="location.reload()" class="btn" style="padding:10px 16px">戻る</button>
            </div>
          </div>
        `;
      }
      function doLogout(){
        try{ localStorage.removeItem('idToken'); }catch(e){}
        if (LOGOUT_URL && typeof LOGOUT_URL === 'string' && LOGOUT_URL.trim() !== "") {
          location.href = LOGOUT_URL;
        } else {
          renderLoggedOut();
        }
      }

      // ====== 初期化 ======
      function init(){
        initChart();
        document.getElementById("load").addEventListener("click",fetchAndDraw);
        document.getElementById("add").addEventListener("click",addWeight);
        document.getElementById("logout").addEventListener("click", doLogout);
        (async()=>{try{await fetchAndDraw();}catch(e){toast(e.message||e,"err");}})();
      }
      init();
    </script>
  </body>
</html>




