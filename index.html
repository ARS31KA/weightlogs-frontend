<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>FitSnap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- BEGIN: Token Receiver (place this at the very top) -->
    <script>
    (function(){
      const qs=new URLSearchParams(location.search);
      const hs=new URLSearchParams(location.hash.slice(1));
      const tok=qs.get('id_token')||qs.get('token')||hs.get('id_token')||hs.get('token');
      if(tok){
        localStorage.setItem('idToken', tok);
        try{history.replaceState({}, "", location.pathname + location.search.replace(/(\?|&)id_token=[^&#]*/,'').replace(/(\?|&)token=[^&#]*/,'').replace(/\?$/,'') );}catch(e){}
        try{history.replaceState({}, "", location.pathname + location.search);}catch(e){}
      }
      window.getAuthHeader=function(){
        const t=localStorage.getItem('idToken');
        if(!t) throw new Error('IdToken が未入力です（URL の ?id_token=... で渡してください）');
        return { Authorization:'Bearer '+t };
      };
    })();
    </script>
    <!-- END: Token Receiver -->

    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
      :root{
        --bg0:#f4f7fb; --bg1:#eaf0ff; --card:#ffffff; --text:#0c1b36;
        --muted:#5e6b86; --line:#d6deee; --accent:#2f7cf6; --accent2:#18c3a1;
        --grid:#c9d6ee; --chip:#eff4ff; --fat:#f55ca6;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; padding:28px;
        background:
          radial-gradient(1200px 600px at 20% -10%, var(--bg1) 0%, var(--bg0) 60%),
          linear-gradient(180deg, var(--bg1), var(--bg0));
        color:var(--text);
        font:16px/1.7 system-ui, Segoe UI, Helvetica, Arial;
      }
      .container{max-width:1080px;margin:0 auto}
      header.apphead{display:flex; align-items:center; gap:14px; margin-bottom:16px;}
      .logo{
        width:48px; height:48px; border-radius:14px;
        background: conic-gradient(from 210deg,var(--accent),#7f9cfb,var(--accent2));
        box-shadow:0 10px 22px rgba(47,124,246,.25);
        display:grid; place-items:center; color:#fff; font-weight:900;
        letter-spacing:.5px; font-size:18px;
      }
      h1{margin:0; font-size:28px; font-weight:900; letter-spacing:.3px}
      .brand-accent{background:linear-gradient(90deg,var(--accent),var(--accent2));
        -webkit-background-clip:text;background-clip:text;color:transparent}
      .card{
        background:var(--card); border:1px solid var(--line); border-radius:16px;
        box-shadow:0 8px 20px rgba(17,32,64,.06); padding:16px;
      }
      .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      label{color:var(--muted); font-size:13px}
      input{
        background:#f8fbff; color:var(--text);
        border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none;
      }
      input[type="datetime-local"]{min-width:240px}
      .btn{
        border:1px solid var(--line); background:#f8fbff; color:#0c1b36;
        padding:10px 14px; border-radius:12px; cursor:pointer;
        transition:.15s transform,.15s background,.15s border-color,.15s filter;
      }
      .btn:hover{transform:translateY(-1px); border-color:#b7c6de; background:#ffffff}
      .btn-primary{background: linear-gradient(90deg, var(--accent), var(--accent2));
        border-color:transparent; color:#fff;}
      .btn-primary:hover{filter:brightness(1.06)}
      .chartbox{position:relative;width:100%;height:520px;border:1px dashed var(--line);
        border-radius:12px;background:var(--chip)}
      .chartbox canvas{position:absolute;inset:0;width:100%!important;height:100%!important;display:block}
      .small{font-size:13px; color:var(--muted)}
      .toast{position:fixed; right:20px; bottom:20px; z-index:9999; background:#fff;
        border:1px solid var(--line); color:var(--text); padding:12px 14px; border-radius:12px;
        box-shadow:0 6px 18px rgba(17,32,64,.12); display:none; max-width:380px}
      #log{display:none}
    </style>
  </head>
  <body>
    <div class="container">
      <header class="apphead">
        <div class="logo">FS</div>
        <div><h1><span class="brand-accent">FitSnap</span></h1></div>
      </header>

      <div class="card" style="margin-bottom:14px">
        <div class="toolbar">
          <div style="display:flex;gap:8px;align-items:center;">
            <label>期間 from</label>
            <input id="from" type="datetime-local">
          </div>
          <button id="load" class="btn">グラフを表示</button>
          <button id="add" class="btn btn-primary">今日の体重を追加</button>
          <span id="last-updated" class="small" style="margin-left:auto">—</span>
        </div>
      </div>

      <div class="card" style="margin-bottom:10px">
        <div class="chartbox"><canvas id="chart"></canvas></div>
      </div>

      <pre id="log"></pre>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ====== 設定 ======
      const BASE_URL = "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";

      // ====== 要素 ======
      const $from  = document.getElementById("from");
      const $log   = document.getElementById("log");
      const $toast = document.getElementById("toast");

      // ====== 状態（直近の items を保持して削除に使う） ======
      let lastItems = []; // [{loggedAt, weightKg, note}, ...]

      // ====== ユーティリティ ======
      const pad = (n)=> String(n).padStart(2,"0");
      function fmtLocal(iso){
        const d=new Date(iso); if(isNaN(d)) return iso;
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function toast(msg, type="ok", ms=2600){
        $toast.className = `toast ${type}`;
        $toast.textContent = String(msg);
        $toast.style.display = 'block';
        clearTimeout($toast._t);
        $toast._t = setTimeout(()=> $toast.style.display='none', ms);
      }
      function setBusy(b, ids=["load","add"]){
        ids.forEach(id=>{
          const el=document.getElementById(id);
          el.disabled = b;
          el.style.opacity = b ? 0.6 : 1;
          el.style.cursor  = b ? "wait" : "pointer";
        });
      }
      function log(msg){ $log.textContent=String(msg); }

      // 直近1か月を既定
      (function setDefaultFrom(){
        const d=new Date(); d.setMonth(d.getMonth()-1);
        const local=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
        $from.value=local;
      })();

      // ====== Chart.js 初期化 ======
      let chart;
      function initChart(){
        const ctx = document.getElementById("chart").getContext('2d');
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        const grid   = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
        const fatCol = getComputedStyle(document.documentElement).getPropertyValue('--fat').trim();

        chart = new Chart(ctx, {
          type: "line",
          data: { labels: [], datasets: [
            {
              label: "体重 (kg)",
              yAxisID: 'yWeight',
              data: [],
              tension: 0.2,
              borderWidth: 3,
              pointRadius: 4,
              pointHoverRadius: 6,
              borderColor: accent,
              backgroundColor: "rgba(47,124,246,0.10)",
              fill: true,
              datalabels: {
                color: "#0c1b36",
                align: 'right', anchor: 'end', offset: 6, clip: false,
                formatter: (v)=> `${Number(v).toFixed(1)} kg`,
                font: { size: 12, weight: '600' },
                display: (ctx)=>{
                  const n = ctx.chart.data.datasets[0].data.length;
                  if (ctx.dataIndex === n-1) return true;
                  if(n>40) return ctx.dataIndex%2===0;
                  return true;
                }
              }
            },
            {
              label: "体脂肪率 (%)",
              yAxisID: 'yFat',
              data: [],
              tension: 0.25,
              borderWidth: 4,
              pointRadius: 5,
              pointHoverRadius: 7,
              borderColor: fatCol,
              backgroundColor: "rgba(245,92,166,0.15)",
              fill: false,
              datalabels: {
                color: fatCol,
                align: 'right',
                anchor: 'end',
                offset: 6,
                clip: false,
                formatter: (v)=> `${Number(v).toFixed(1)} %`,
                font: { size: 12, weight: '700' },
                display: (ctx)=>{
                  const n = ctx.chart.data.datasets[1].data.length;
                  if (ctx.dataIndex === n-1) return true;
                  if (n > 40) return ctx.dataIndex % 2 === 0;
                  return true;
                }
              }
            }
          ]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 250 },
            interaction: { mode: "nearest", intersect: false },
            plugins: {
              legend: { labels: { color: "var(--muted)" } },
              tooltip: {
                backgroundColor: "#ffffff", borderColor: "#d7dfec", borderWidth: 1,
                titleColor: "#0c1b36", bodyColor: "#334568",
                callbacks: {
                  label: (ctx)=>{
                    const y = ctx.parsed.y;
                    return ctx.dataset.yAxisID==='yFat' ? ` ${y.toFixed(1)} %` : ` ${y.toFixed(1)} kg`;
                  },
                  title: (items)=> items.map(it=> it.label)
                }
              }
            },
            scales: {
              x: {
                grid: { color: grid }, ticks: { color: "var(--muted)" },
                title: { display: true, text: "日時 (ローカル)", color: "var(--muted)" },
              },
              yWeight: {
                position:'left',
                grid: { color: grid }, ticks: { color: "var(--muted)" },
                suggestedMin: 40, suggestedMax: 90,
                title: { display: true, text: "kg", color: "var(--muted)" },
              },
              yFat: {
                position:'right',
                grid: { drawOnChartArea:false },
                ticks: { color: "var(--muted)", callback:(v)=> `${v}%` },
                suggestedMin: 5, suggestedMax: 40,
                title: { display: true, text: "%", color: "var(--muted)" },
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        // === ダブルクリックで削除 ===
        const canvas = ctx.canvas;
        canvas.addEventListener('dblclick', async (evt)=>{
          try{
            // クリック点に最も近い要素（点）を取得（交差必須）
            const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (!points || points.length === 0) return;

            const { datasetIndex, index } = points[0];

            // index は labels & lastItems と同じ並び（fetchAndDraw で sort 済み）
            const target = lastItems[index];
            if (!target || !target.loggedAt) return;

            const dateStr = fmtLocal(target.loggedAt);
            const ok = confirm(`このデータを削除しますか？\n日時: ${dateStr}\n体重: ${target.weightKg} kg`);
            if (!ok) return;

            // API 呼び出し（DELETE /weights?loggedAt=...）
            const url = `${BASE_URL}/weights?loggedAt=${encodeURIComponent(target.loggedAt)}`;
            const res = await fetch(url, { method: 'DELETE', headers: window.getAuthHeader() });
            const text = await res.text();
            if (!res.ok) throw new Error(`DELETE 失敗: ${res.status} ${text}`);

            toast("削除しました");
            await fetchAndDraw(); // 再取得して両データセットを更新
          }catch(e){
            console.error(e);
            toast(e.message || e, "err");
          }
        });
      }

      // ====== 年齢計算 ======
      function calcAgeFromBirthDate(yyyyMmDd){
        if(!/^\d{4}-\d{2}-\d{2}$/.test(yyyyMmDd||"")) return null;
        const [y,m,d]=yyyyMmDd.split('-').map(Number);
        const t=new Date(); let age=t.getFullYear()-y;
        const passed=(t.getMonth()+1>m)||((t.getMonth()+1===m)&&(t.getDate()>=d));
        if(!passed) age--;
        return age;
      }

      // ====== プロフィール取得 ======
      let profile = null; // { heightCm, birthDate, gender }
      async function fetchProfile(){
        const res=await fetch(`${BASE_URL}/profile`,{ headers: window.getAuthHeader() });
        const text=await res.text();
        if(!res.ok) throw new Error(`GET /profile 失敗: ${res.status} ${text}`);
        const json=JSON.parse(text);
        profile = json.profile || null;
        return profile;
      }

      // ====== データ取得 → グラフ描画 ======
      async function fetchAndDraw(){
        try{
          setBusy(true);
          if(!profile){ await fetchProfile(); }

          const fromVal=$from.value;
          const fromISO=fromVal? new Date(fromVal).toISOString() : "1970-01-01T00:00:00Z";
          const url=`${BASE_URL}/weights?from=${encodeURIComponent(fromISO)}`;

          const res=await fetch(url,{ headers: window.getAuthHeader() });
          const text=await res.text();
          if(!res.ok) throw new Error(`GET 失敗: ${res.status} ${text}`);
          const json=JSON.parse(text);

          // 並びを確定し、lastItems に保持（削除時に loggedAt を使う）
          lastItems = (json.items||[]).slice().sort((a,b)=> a.loggedAt.localeCompare(b.loggedAt));

          chart.data.labels = lastItems.map(x=> fmtLocal(x.loggedAt));
          chart.data.datasets[0].data = lastItems.map(x=> Number(x.weightKg));

          // 体脂肪率を計算
          let fats = [];
          if(profile && Number(profile.heightCm)>0 && profile.gender){
            const h = Number(profile.heightCm)/100;
            const age = (function(){
              const a = profile.birthDate ? (()=>{
                const t=new Date();
                const [y,m,d]=profile.birthDate.split('-').map(Number);
                let A = t.getFullYear()-y;
                const passed=(t.getMonth()+1>m)||((t.getMonth()+1===m)&&(t.getDate()>=d));
                if(!passed) A--;
                return A;
              })() : null;
              return a ?? 30;
            })();
            const sex = (String(profile.gender).toLowerCase()==='male') ? 1 : 0;
            fats = lastItems.map(x=>{
              const w = Number(x.weightKg);
              const bmi = w/(h*h);
              return 1.20*bmi + 0.23*age - 10.8*sex - 5.4;
            });
          }
          chart.data.datasets[1].data = fats;
          chart.update('none');

          if(lastItems.length===0){
            log("データはありません"); toast("データはありません","ok");
          }else{
            log(`GET OK (${lastItems.length}件)\n`+JSON.stringify(lastItems.slice(-10),null,2));
            toast("グラフを更新しました");
          }
          document.getElementById('last-updated').textContent="最終更新: "+new Date().toLocaleString();
        }catch(e){
          console.error(e); log(e.message||e); toast(e.message||e,"err");
        }finally{ setBusy(false); }
      }

      // ====== 体重を1件追加（POST） ======
      async function addWeight(){
        try{
          setBusy(true,["add"]);
          const input=prompt("今日の体重(kg)を入力:", "62.8");
          if(input==null) return;
          const weight=Number(input);
          if(!Number.isFinite(weight)) return toast("数値を入力してください","err");

          const res=await fetch(`${BASE_URL}/weights`,{
            method:"POST",
            headers:{ "Content-Type":"application/json", ...window.getAuthHeader() },
            body:JSON.stringify({ weightKg:weight }),
          });
          const text=await res.text();
          if(!res.ok) throw new Error(`POST 失敗: ${res.status} ${text}`);
          log(`POST OK\n${text}`); toast("追加しました");
          await fetchAndDraw();
        }catch(e){
          console.error(e); log(e.message||e); toast(e.message||e,"err");
        }finally{ setBusy(false,["add"]); }
      }

      // ====== 初期化 ======
      initChart();
      document.getElementById("load").addEventListener("click", fetchAndDraw);
      document.getElementById("add").addEventListener("click", addWeight);
      (async ()=>{ try{ await fetchProfile(); await fetchAndDraw(); } catch(e){ toast(e.message||e,"err"); } })();
    </script>
  </body>
</html>
