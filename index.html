<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>体重グラフ (WeightLogs)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
      body {
        font-family: system-ui, Segoe UI, Helvetica, Arial;
        margin: 24px;
        line-height: 1.6;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }
      input,
      button {
        font-size: 16px;
        padding: 6px 10px;
      }
      canvas {
        max-width: 960px;
        width: 100%;
        height: 360px;
      }
      small {
        color: #555;
      }
      .grow {
        flex: 1 1 360px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
    </style>
  </head>
  <body>
    <h1>体重遷移</h1>

    <div class="row">
      <label class="mono">IdToken:</label>
      <input
        id="idToken"
        class="grow"
        placeholder="eyJraWQiOiJYd3U0d092TzlmZVpmT2NqZ0R1M1pvb2owMkFWd2ljZ0F5dFZ1bWhzbGo0PSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiIwNDE4MTQzOC05MGExLTcwYjEtM2MxMy02MjRlNmRlZmY5NjMiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiaXNzIjoiaHR0cHM6XC9cL2NvZ25pdG8taWRwLnVzLWVhc3QtMS5hbWF6b25hd3MuY29tXC91cy1lYXN0LTFfODlsWWhCVEdJIiwiY29nbml0bzp1c2VybmFtZSI6IjA0MTgxNDM4LTkwYTEtNzBiMS0zYzEzLTYyNGU2ZGVmZjk2MyIsIm9yaWdpbl9qdGkiOiJhODMwZDhiZi0yMWEyLTRkNWUtYjhlMC1iODFiNzlkMjA1MzIiLCJhdWQiOiI2djBjYmsyb3Y5bnRsdXE0dGgzYjk3YnZuMCIsImV2ZW50X2lkIjoiYjgyNDM0NjgtZjE1OC00ODAxLWE0YjEtMzBmZjQ4YzFhMTQ3IiwidG9rZW5fdXNlIjoiaWQiLCJhdXRoX3RpbWUiOjE3NjA0MDE3NTcsImV4cCI6MTc2MDQ4ODE1NywiaWF0IjoxNzYwNDAxNzU3LCJqdGkiOiJmMzMyZTlmYy1jODM3LTRkNDItODA3OS1mMzg2OWVkZDk2ZWUiLCJlbWFpbCI6InRlc3QxMDEzQGV4YW1wbGUuY29tIn0.ssVJHkT2eG2FdE9SFy4a17EsESnzRYUvsMXEEdy55FCAqMdP_ksnlCwCAE-7iRyH8kwINqQxIYX6NsGZ67DjUC4-4HpUE2D9AGOX1QhUgOwTh6d-jWSomaq_sqnM-C74Tkn-qdow4c7Mv9YBvCabRgi9d3rQsmRr5Undb-oSxbS9esAs_bBsfonHdfxyCqh4zMTffToG0vuzarVUDHq9QzSIaNTkZKZhZeBK3AP9ThbjjoNMsSccLOJulf1E2HybDBxiJ1CgGNcptvMQh6kmp6tybS3wjCpH-u1tTIvPS02asm9WEwQWgZLuCKErsdwTQ9eE3_DdZnEmxg3ORNhewQ"
      />
    </div>

    <div class="row">
      <label>期間 from:</label>
      <input id="from" type="datetime-local" />
      <button id="load">読み込み（GET）</button>
      <button id="add">今日の体重を追加（POST）</button>
    </div>

    <small
      >※ トークンは一時的にブラウザの LocalStorage
      に保存します（このPC内のみ）。無効化は「トークン消去」を押してください。</small
    >
    <div class="row" style="margin-top: 8px">
      <button id="saveToken">トークン保存</button>
      <button id="clearToken">トークン消去</button>
    </div>

    <canvas id="chart"></canvas>

    <pre
      id="log"
      style="
        white-space: pre-wrap;
        background: #f7f7f7;
        padding: 8px;
        border-radius: 6px;
        margin-top: 12px;
      "
    ></pre>

    <script>
      // ====== 設定 ======
      const BASE_URL =
        "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";

      // ====== UI要素 ======
      const $token = document.getElementById("idToken");
      const $from = document.getElementById("from");
      const $log = document.getElementById("log");

      // ====== LocalStorage（簡便） ======
      (function restoreToken() {
        const t = localStorage.getItem("idToken");
        if (t) $token.value = t;
      })();

      document.getElementById("saveToken").onclick = () => {
        const t = $token.value.trim();
        if (!t) return alert("IdToken を入力してください");
        localStorage.setItem("idToken", t);
        alert("保存しました");
      };
      document.getElementById("clearToken").onclick = () => {
        localStorage.removeItem("idToken");
        $token.value = "";
        alert("消去しました");
      };

      // ====== Chart.js 初期化 ======
      const ctx = document.getElementById("chart");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{ label: "体重 (kg)", data: [], tension: 0.2 }],
        },
        options: {
          responsive: true,
          interaction: { mode: "nearest", intersect: false },
          scales: {
            x: { title: { display: true, text: "日時 (ローカル)" } },
            y: {
              title: { display: true, text: "kg" },
              suggestedMin: 40,
              suggestedMax: 90,
            },
          },
          plugins: { legend: { display: true } },
        },
      });

      // ISO → ローカル表示
      function fmtLocal(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function log(msg) {
        $log.textContent = String(msg);
      }

      function getAuthHeader() {
        const t = $token.value.trim();
        if (!t)
          throw new Error(
            "IdToken が未入力です（A さんの認証後に取得した IdToken を貼ってください）"
          );
        return { Authorization: `Bearer ${t}` };
      }

      // ====== データ取得 → グラフ描画 ======
      async function fetchAndDraw() {
        try {
          const fromVal = $from.value;
          const fromISO = fromVal
            ? new Date(fromVal).toISOString()
            : "1970-01-01T00:00:00Z";
          const url = `${BASE_URL}/weights?from=${encodeURIComponent(fromISO)}`;

          const res = await fetch(url, { headers: getAuthHeader() });
          const text = await res.text();
          if (!res.ok) throw new Error(`GET 失敗: ${res.status} ${text}`);
          const json = JSON.parse(text);
          const items = (json.items || [])
            .slice()
            .sort((a, b) => a.loggedAt.localeCompare(b.loggedAt));

          chart.data.labels = items.map((x) => fmtLocal(x.loggedAt));
          chart.data.datasets[0].data = items.map((x) => Number(x.weightKg));
          chart.update();
          log(
            `GET OK (${items.length}件)\n` +
              JSON.stringify(items.slice(-5), null, 2)
          ); // 末尾5件だけ表示
        } catch (e) {
          console.error(e);
          log(e.message || e);
          alert(e.message || e);
        }
      }

      // ====== 体重を1件追加（POST） ======
      async function addWeight() {
        try {
          const input = prompt("今日の体重(kg)を入力:", "62.8");
          if (input == null) return;
          const weight = Number(input);
          if (!Number.isFinite(weight)) return alert("数値を入力してください");

          const res = await fetch(`${BASE_URL}/weights`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...getAuthHeader() },
            body: JSON.stringify({ weightKg: weight }),
          });
          const text = await res.text();
          if (!res.ok) throw new Error(`POST 失敗: ${res.status} ${text}`);
          log(`POST OK\n${text}`);
          await fetchAndDraw();
        } catch (e) {
          console.error(e);
          log(e.message || e);
          alert(e.message || e);
        }
      }

      // イベント
      document.getElementById("load").addEventListener("click", fetchAndDraw);
      document.getElementById("add").addEventListener("click", addWeight);

      // 初期表示（必要ならコメントアウト）
      fetchAndDraw();
    </script>
  </body>
</html>
