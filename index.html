<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>体重グラフ (WeightLogs)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- BEGIN: Token Receiver (place this at the very top) -->
    <script>
    (function(){
      // 1) URL からトークンを拾う（?id_token=... / #id_token=... / ?token=... / #token=...）
      const qs  = new URLSearchParams(location.search);
      const hs  = new URLSearchParams(location.hash.slice(1));
      const tok = qs.get('id_token') || qs.get('token') || hs.get('id_token') || hs.get('token');

      // 2) 受け取れたら localStorage に保存（キーは 'idToken'）→ URL をクリーンアップ
      if (tok) {
        localStorage.setItem('idToken', tok);
        try { history.replaceState({}, "", location.pathname + location.search.replace(/(\?|&)id_token=[^&#]*/,'').replace(/(\?|&)token=[^&#]*/,'').replace(/\?$/,'') ); } catch(e){}
        try { history.replaceState({}, "", location.pathname + location.search); } catch(e){}
      }

      // 3) 共通ヘッダを作る関数
      window.getAuthHeader = function(){
        const t = localStorage.getItem('idToken');
        if (!t) throw new Error('IdToken が未入力です（A の認証後に受け取った IdToken を URL で渡すか、このページの入力欄に貼って保存してください）');
        return { Authorization: 'Bearer ' + t };
      };
    })();
    </script>
    <!-- END: Token Receiver -->

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <style>
      :root{
        --bg:#0b0c0f;          /* 背景 */
        --card:#111318;        /* カード背景 */
        --text:#e7e9ee;        /* 文字色 */
        --muted:#9aa3b2;       /* 補助文字 */
        --accent:#4f8cff;      /* アクセント */
        --line:#1c2028;        /* 罫線/グリッド */
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; padding:24px;
        background:linear-gradient(180deg,#0b0c0f, #0d1117 40%, #0b0c0f);
        color:var(--text);
        font:16px/1.6 system-ui, Segoe UI, Helvetica, Arial;
      }
      .container{max-width:1040px;margin:0 auto}
      h1{margin:0 0 12px; font-weight:700; letter-spacing:.3px; font-size:28px;}
      .subtitle{color:var(--muted); margin-bottom:20px}

      .card{
        background:var(--card);
        border:1px solid var(--line);
        border-radius:14px;
        box-shadow:0 8px 24px rgba(0,0,0,.35);
        padding:16px;
      }
      .row,.toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      .field{display:flex; gap:8px; align-items:center; flex:1 1 auto}
      label{color:var(--muted); font-size:14px}
      input{
        background:#0f1218; color:var(--text);
        border:1px solid var(--line);
        border-radius:10px; padding:10px 12px;
        outline:none;
      }
      input::placeholder{color:#5d6a7c}
      input[type="datetime-local"]{min-width:240px}
      input.grow{flex:1 1 420px}

      .btn{
        border:1px solid var(--line);
        background:#151a23; color:var(--text);
        padding:10px 14px; border-radius:10px; cursor:pointer;
        transition:.15s transform,.15s background,.15s border-color;
      }
      .btn:hover{transform:translateY(-1px); border-color:#2a303b}
      .btn:disabled{opacity:.6; cursor:not-allowed}
      .btn-primary{background:var(--accent); border-color:transparent; color:#fff}
      .btn-primary:hover{filter:brightness(1.05)}
      .btn-ghost{background:transparent}

      canvas{width:100%; height:420px}
      .log{white-space:pre-wrap;background:#0f1218;border:1px solid var(--line);
           color:#c7cede;border-radius:10px;padding:10px;margin-top:12px}
      .small{font-size:13px; color:var(--muted)}

      .toast{
        position:fixed; right:20px; bottom:20px; z-index:9999;
        background:#111318; border:1px solid var(--line); color:var(--text);
        padding:12px 14px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.35);
        display:none; max-width:380px
      }
      .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>体重遷移</h1>
      <div class="subtitle">ログイン済みの IdToken で API を呼び出し、過去データを可視化します。</div>

      <!-- トークンカード -->
      <div class="card" style="margin-bottom:14px">
        <div class="toolbar">
          <div class="field">
            <label class="mono">IdToken</label>
            <input id="idToken" class="grow" placeholder="Paste または URL ?id_token=... で自動保存">
          </div>
          <button id="saveToken" class="btn">トークン保存</button>
          <button id="clearToken" class="btn btn-ghost">トークン消去</button>
        </div>
        <!-- 任意の貼り付けUI（未保存時のみ表示） -->
        <div id="paste-token" style="display:none;margin-top:10px" class="field">
          <input id="token-input" placeholder="Paste IdToken here" style="width:60%">
          <button class="btn" onclick="localStorage.setItem('idToken', document.getElementById('token-input').value.trim()); location.reload();">保存</button>
          <span class="small">※ 未保存のときだけ表示</span>
        </div>
      </div>

      <!-- 操作カード -->
      <div class="card" style="margin-bottom:14px">
        <div class="toolbar">
          <div class="field" style="flex:0 0 auto">
            <label>期間 from</label>
            <input id="from" type="datetime-local">
          </div>
          <button id="load" class="btn">読み込み（GET）</button>
          <button id="add" class="btn btn-primary">今日の体重を追加（POST）</button>
          <span id="last-updated" class="small" style="margin-left:auto">—</span>
        </div>
      </div>

      <!-- グラフ -->
      <div class="card" style="margin-bottom:14px">
        <canvas id="chart"></canvas>
      </div>

      <!-- ログ -->
      <pre id="log" class="log"></pre>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ====== 設定 ======
      const BASE_URL = "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";

      // ====== 要素 ======
      const $token = document.getElementById("idToken");
      const $from  = document.getElementById("from");
      const $log   = document.getElementById("log");
      const $toast = document.getElementById("toast");

      // ====== トースト & ビジー表示 ======
      function toast(msg, type="ok", ms=2800){
        $toast.className = `toast ${type}`;
        $toast.textContent = String(msg);
        $toast.style.display = 'block';
        clearTimeout($toast._t);
        $toast._t = setTimeout(()=> $toast.style.display='none', ms);
      }
      function setBusy(b, btns=["load","add"]){
        btns.forEach(id=>{
          const el = document.getElementById(id);
          el.disabled = b;
          el.style.opacity = b ? .6 : 1;
          el.style.cursor  = b ? "wait" : "pointer";
        });
      }

      // ====== LocalStorage 表示 & 貼り付けUI制御 ======
      (function initTokenUI(){
        const t = localStorage.getItem("idToken");
        if (t) $token.value = t;
        if (!t) document.getElementById('paste-token').style.display='flex';
      })();

      document.getElementById("saveToken").onclick = () => {
        const t = $token.value.trim();
        if (!t) return toast("IdToken を入力してください", "err");
        localStorage.setItem("idToken", t);
        toast("保存しました");
      };
      document.getElementById("clearToken").onclick = () => {
        localStorage.removeItem("idToken");
        $token.value = "";
        toast("消去しました");
        location.reload();
      };

      // ====== Chart.js 初期化 ======
      const chart = new Chart(document.getElementById("chart"), {
        type: "line",
        data: { labels: [], datasets: [{
          label: "体重 (kg)",
          data: [],
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 2,
          borderColor: "#4f8cff",
          backgroundColor: "rgba(79,140,255,.15)",
          fill: true,
        }]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 250 },
          interaction: { mode: "nearest", intersect: false },
          plugins: {
            legend: { labels: { color: "#c7cede" } },
            tooltip: {
              callbacks: {
                label: (ctx) => ` ${ctx.parsed.y.toFixed(1)} kg`,
                title: (items) => items.map(it => it.label)
              }
            },
          },
          scales: {
            x: {
              grid: { color: "rgba(28,32,40,.6)" },
              ticks: { color: "#aab3c2" },
              title: { display: true, text: "日時 (ローカル)", color: "#aab3c2" },
            },
            y: {
              grid: { color: "rgba(28,32,40,.6)" },
              ticks: { color: "#aab3c2" },
              suggestedMin: 40, suggestedMax: 90,
              title: { display: true, text: "kg", color: "#aab3c2" },
            },
          },
        },
      });

      // ====== ユーティリティ ======
      const pad = (n) => String(n).padStart(2, "0");
      function fmtLocal(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function log(msg){ $log.textContent = String(msg); }

      // 初期 from（直近1か月）
      (function setDefaultFrom(){
        if ($from.value) return;
        const d = new Date(); d.setMonth(d.getMonth() - 1);
        // datetime-local 用にローカル時差を差し引いて "YYYY-MM-DDTHH:MM"
        const local = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
        $from.value = local;
      })();

      // ====== データ取得 → グラフ描画 ======
      async function fetchAndDraw(){
        try{
          setBusy(true);
          const fromVal = $from.value;
          const fromISO = fromVal ? new Date(fromVal).toISOString() : "1970-01-01T00:00:00Z";
          const url = `${BASE_URL}/weights?from=${encodeURIComponent(fromISO)}`;

          const res  = await fetch(url, { headers: window.getAuthHeader() });
          const text = await res.text();
          if (!res.ok) throw new Error(`GET 失敗: ${res.status} ${text}`);

          const json  = JSON.parse(text);
          const items = (json.items || []).slice().sort((a,b)=> a.loggedAt.localeCompare(b.loggedAt));

          chart.data.labels         = items.map(x => fmtLocal(x.loggedAt));
          chart.data.datasets[0].data = items.map(x => Number(x.weightKg));
          chart.update();

          if(items.length === 0){
            log("データはありません");
            toast("データはありません", "ok");
          }else{
            log(`GET OK (${items.length}件)\n` + JSON.stringify(items.slice(-5), null, 2));
            toast("読み込み完了");
          }
          document.getElementById('last-updated').textContent = "最終更新: " + new Date().toLocaleString();
        }catch(e){
          console.error(e);
          log(e.message || e);
          toast(e.message || e, "err");
        }finally{
          setBusy(false);
        }
      }

      // ====== 体重を1件追加（POST） ======
      async function addWeight(){
        try{
          setBusy(true, ["add"]);
          const input = prompt("今日の体重(kg)を入力:", "62.8");
          if (input == null) return;
          const weight = Number(input);
          if (!Number.isFinite(weight)) return toast("数値を入力してください", "err");

          const res  = await fetch(`${BASE_URL}/weights`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...window.getAuthHeader() },
            body: JSON.stringify({ weightKg: weight }),
          });
          const text = await res.text();
          if (!res.ok) throw new Error(`POST 失敗: ${res.status} ${text}`);
          log(`POST OK\n${text}`);
          toast("追加しました");
          await fetchAndDraw();
        }catch(e){
          console.error(e);
          log(e.message || e);
          toast(e.message || e, "err");
        }finally{
          setBusy(false, ["add"]);
        }
      }

      // イベント
      document.getElementById("load").addEventListener("click", fetchAndDraw);
      document.getElementById("add").addEventListener("click", addWeight);

      // 初期表示
      fetchAndDraw();
    </script>
  </body>
</html>
