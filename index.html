<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WeightLogs Frontend</title>

    <!-- BEGIN: Token Receiver (place this at the very top) -->
    <script>
    (function(){
      // 1) URL からトークンを拾う（どちらでもOK：?id_token=... / #id_token=... / ?token=... / #token=...）
      const qs  = new URLSearchParams(location.search);
      const hs  = new URLSearchParams(location.hash.slice(1));
      const tok = qs.get('id_token') || qs.get('token') || hs.get('id_token') || hs.get('token');

      // 2) 受け取れたら localStorage に保存（キーは 'idToken' とする）→ URL をクリーンアップ
      if (tok) {
        localStorage.setItem('idToken', tok);
        try { history.replaceState({}, "", location.pathname + location.search.replace(/(\?|&)id_token=[^&#]*/,'').replace(/(\?|&)token=[^&#]*/,'').replace(/\?$/,'') ); }
        catch(e){}
        // ハッシュも消す
        try { history.replaceState({}, "", location.pathname + location.search); }
        catch(e){}
      }

      // 3) 共通ヘッダを作る関数（未入力なら明確なメッセージ）
      window.getAuthHeader = function(){
        const t = localStorage.getItem('idToken');
        if (!t) throw new Error('IdToken が未入力です（A の認証後に受け取った IdToken を URL で渡すか、このページの入力欄に貼って保存してください）');
        return { Authorization: 'Bearer ' + t };
      };
    })();
    </script>
    <!-- END: Token Receiver -->

    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; line-height: 1.6; }
      header { margin-bottom: 16px; }
      .card { border: 1px solid #ccc; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
      .row { display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      input[type="text"], input[type="url"] { padding: 8px; border: 1px solid #bbb; border-radius: 8px; width: 100%; max-width: 640px; }
      button { padding: 8px 14px; border: 1px solid #888; border-radius: 8px; background: transparent; cursor: pointer; }
      code { padding: 2px 6px; background: #f4f4f4; border-radius: 6px; }
      .ok { color: #057a55; }
      .warn { color: #b7791f; }
      .err { color: #c53030; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .small { font-size: 0.9em; opacity: .9; }
      .muted { opacity: .75; }
      .hidden { display:none; }
      .flex-col { display:flex; flex-direction:column; gap:8px; }
      .mt8 { margin-top: 8px; }
      .mt12 { margin-top: 12px; }
      .mt16 { margin-top: 16px; }
      .mt24 { margin-top: 24px; }
      textarea { width: 100%; max-width: 780px; height: 160px; padding: 10px; border-radius: 8px; border: 1px solid #bbb; }
    </style>
  </head>

  <body>
    <header>
      <h1>WeightLogs Frontend</h1>
      <div class="small muted">GitHub Pages 上で IdToken をローカルに保持し、API に <code>Authorization: Bearer &lt;idToken&gt;</code> を付与して呼び出します。</div>
    </header>

    <!-- 貼り付けUI（IdToken 未保存時のみ表示） -->
    <div id="paste-token" class="card" style="display:none;">
      <h2>IdToken を保存</h2>
      <div class="flex-col">
        <input id="token-input" placeholder="Paste IdToken here (A 側の認証で発行された IdToken を貼り付け)" />
        <div class="row">
          <button id="save-token-btn">保存してリロード</button>
          <button id="clear-token-btn">削除</button>
        </div>
        <div class="small muted">URL で <code>?id_token=... </code> / <code>#id_token=...</code> で渡しても自動保存されます。</div>
      </div>
    </div>

    <!-- ステータス -->
    <div class="card">
      <h2>トークン・ステータス</h2>
      <div id="token-status" class="mono">読み込み中...</div>
      <div class="row mt8">
        <button id="btn-show-claims">JWT クレームを表示（検証なしのデコード）</button>
        <button id="btn-logout">ログアウト（IdToken 削除）</button>
      </div>
      <textarea id="claims-output" class="mt12 mono hidden" readonly></textarea>
      <div class="small muted mt8">
        * ここでの JWT デコードは署名検証を行いません（バックエンドで必ず検証してください）。<br/>
        * セキュリティのためコンソール等にトークンを出力しないでください。
      </div>
    </div>

    <!-- API テスト -->
    <div class="card">
      <h2>API テスト</h2>
      <div class="flex-col">
        <label for="api-base">API Base URL（要置換）</label>
        <input id="api-base" type="url" placeholder="https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/prod" />
        <div class="row">
          <button id="btn-test-get">GET /health（例）</button>
          <button id="btn-test-post">POST /echo（例）</button>
        </div>
        <textarea id="api-output" class="mt12 mono" readonly></textarea>
      </div>
      <div class="small muted mt8">
        * CORS 設定（API Gateway）<br/>
        Allowed Origin: <code>https://ars31ka.github.io</code><br/>
        Allowed Headers: <code>Authorization, Content-Type</code><br/>
        Allowed Methods: <code>GET,POST,OPTIONS</code><br/>
        OPTIONS は 204 + 上記CORSヘッダ
      </div>
    </div>

    <script>
      // ====== 設定：あなたの API Gateway のベース URL をここで設定 ======
      // 例: "https://abc123.execute-api.ap-northeast-1.amazonaws.com/prod"
      const DEFAULT_API_BASE = "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod"; // ← 空のままでも UI 側で入力できます

      // 便利関数：API fetch ラッパ（Authorization 付与）
      async function apiFetch(path, options = {}) {
        const apiBaseInput = document.getElementById('api-base');
        const base = (apiBaseInput.value || DEFAULT_API_BASE || "").replace(/\/+$/,'');
        if (!base) throw new Error("API Base URL が未設定です。上の入力欄に設定してください。");
        const url = base + (path.startsWith('/') ? path : '/' + path);

        const headers = { ...(options.headers || {}), ...window.getAuthHeader() };
        const res = await fetch(url, { ...options, headers });

        // 表示用
        const text = await res.text();
        const out = [
          `REQUEST  ${options.method || 'GET'} ${url}`,
          `STATUS   ${res.status}`,
          `HEADERS  ${JSON.stringify(Object.fromEntries(res.headers.entries()), null, 2)}`,
          `BODY     ${text}`
        ].join('\n');
        document.getElementById('api-output').value = out;

        if (!res.ok) {
          // 401/403/CORS失敗など
          throw new Error(`API error: ${res.status}`);
        }
        try { return JSON.parse(text); } catch { return text; }
      }

      // ====== UI 初期化 ======
      function updateTokenStatus() {
        const t = localStorage.getItem('idToken');
        const el = document.getElementById('token-status');
        const paste = document.getElementById('paste-token');

        if (t) {
          const masked = t.length > 24 ? (t.slice(0, 12) + "..." + t.slice(-12)) : "(short token)";
          el.innerHTML = `<span class="ok">IdToken 保存済み</span> <span class="small muted">(一部表示)</span>: <span class="mono">${masked}</span>`;
          paste.style.display = 'none';
        } else {
          el.innerHTML = `<span class="warn">IdToken 未保存</span>：URL で <code>?id_token=...</code> を渡すか、下の入力欄に貼って保存してください。`;
          paste.style.display = 'block';
        }
      }

      // ====== イベント束ね ======
      window.addEventListener('DOMContentLoaded', () => {
        // API Base 既定値
        document.getElementById('api-base').value = DEFAULT_API_BASE;

        // 保存/削除ボタン
        document.getElementById('save-token-btn').addEventListener('click', () => {
          const v = document.getElementById('token-input').value.trim();
          if (!v) return alert('IdToken を入力してください');
          localStorage.setItem('idToken', v);
          location.reload();
        });
        document.getElementById('clear-token-btn').addEventListener('click', () => {
          localStorage.removeItem('idToken');
          location.reload();
        });
        document.getElementById('btn-logout').addEventListener('click', () => {
          localStorage.removeItem('idToken');
          location.reload();
        });

        // JWT クレーム表示（検証なし）
        document.getElementById('btn-show-claims').addEventListener('click', () => {
          const t = localStorage.getItem('idToken');
          const out = document.getElementById('claims-output');
          if (!t) { alert('IdToken 未保存です'); return; }
          try {
            const parts = t.split('.');
            if (parts.length < 2) throw new Error('JWT 形式ではありません');
            const payload = JSON.parse(decodeURIComponent(escape(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')))));
            out.classList.remove('hidden');
            out.value = JSON.stringify(payload, null, 2);
          } catch (e) {
            out.classList.remove('hidden');
            out.value = 'デコードに失敗しました: ' + e.message;
          }
        });

        // GET/POST テスト
        document.getElementById('btn-test-get').addEventListener('click', async () => {
          try {
            await apiFetch('/health', { method: 'GET' });
          } catch (e) {
            // 画面下部に結果は出るのでここでは控えめに
            console.warn(e);
          }
        });

        document.getElementById('btn-test-post').addEventListener('click', async () => {
          try {
            await apiFetch('/echo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ now: new Date().toISOString(), hello: 'world' })
            });
          } catch (e) {
            console.warn(e);
          }
        });

        // 初期ステータス表示
        updateTokenStatus();
      });
    </script>
  </body>
</html>
