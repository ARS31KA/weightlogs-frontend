<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ä½“é‡ãƒ»ä½“è„‚è‚ªç‡ã‚°ãƒ©ãƒ• (WeightLogs)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <!-- BEGIN: Token Receiver -->
    <script>
      (function () {
        const qs = new URLSearchParams(location.search);
        const hs = new URLSearchParams(location.hash.slice(1));
        const tok =
          qs.get("id_token") ||
          qs.get("token") ||
          hs.get("id_token") ||
          hs.get("token");
        if (tok) {
          localStorage.setItem("idToken", tok);
          try {
            history.replaceState({}, "", location.pathname);
          } catch (e) {}
        }

        window.getAuthHeader = function () {
          const t = localStorage.getItem("idToken");
          if (!t)
            throw new Error(
              "IdToken ãŒæœªå…¥åŠ›ã§ã™ï¼ˆA ã®èªè¨¼å¾Œã«URLã§å—ã‘å–ã‚‹ã‹ã€è²¼ã‚Šä»˜ã‘ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰"
            );
          return { Authorization: "Bearer " + t };
        };
      })();
    </script>
    <!-- END: Token Receiver -->

    <style>
      body {
        font-family: "Segoe UI", Helvetica, Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #111827, #1f2937);
        color: #e5e7eb;
      }
      h1 {
        text-align: center;
        color: #60a5fa;
      }
      .card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        margin-bottom: 16px;
      }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
      }
      button:hover {
        background: #2563eb;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid #3b82f6;
      }
      .small {
        font-size: 14px;
        color: #9ca3af;
      }
      input {
        font-size: 16px;
        padding: 6px;
        border-radius: 6px;
        border: none;
        flex: 1;
      }
      canvas {
        width: 100%;
        height: 380px;
      }
      pre {
        background: rgba(255, 255, 255, 0.07);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <h1>ä½“é‡ãƒ»ä½“è„‚è‚ªç‡ã‚°ãƒ©ãƒ•</h1>

    <!-- ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†UIï¼ˆéè¡¨ç¤ºæ–¹å¼Bï¼‰ -->
    <div class="card">
      <div class="toolbar">
        <span id="tokenStatus" class="small">â€”</span>
        <div style="display:flex; gap:6px;">
          <button id="showPaste">ãƒˆãƒ¼ã‚¯ãƒ³è²¼ã‚Šä»˜ã‘</button>
          <button id="clearToken" class="btn-ghost">ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆå»</button>
        </div>
      </div>

      <div id="paste-token" style="display:none; margin-top:10px;">
        <input id="token-input" placeholder="IdToken ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘" style="width:60%">
        <button id="doSavePaste">ä¿å­˜</button>
      </div>
    </div>

    <!-- ğŸ“… æ“ä½œUI -->
    <div class="card">
      <div class="toolbar">
        <label>æœŸé–“ from:</label>
        <input id="from" type="datetime-local" />
        <button id="load">èª­ã¿è¾¼ã¿ï¼ˆGETï¼‰</button>
        <button id="add">ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼ˆPOSTï¼‰</button>
      </div>
    </div>

    <canvas id="chart"></canvas>
    <pre id="log"></pre>

    <script>
      const BASE_URL =
        "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";

      const $from = document.getElementById("from");
      const $log = document.getElementById("log");
      let chart;

      function fmtLocal(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function log(msg) {
        $log.textContent = msg;
      }

      // ğŸ¨ Chart.js åˆæœŸåŒ–
      const ctx = document.getElementById("chart");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "ä½“é‡ (kg)",
              data: [],
              borderColor: "#60a5fa",
              backgroundColor: "rgba(96,165,250,0.2)",
              tension: 0.3,
              yAxisID: "y1",
            },
            {
              label: "ä½“è„‚è‚ªç‡ (%)",
              data: [],
              borderColor: "#f472b6",
              borderDash: [5, 4],
              tension: 0.3,
              yAxisID: "y2",
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "æ—¥æ™‚ (ãƒ­ãƒ¼ã‚«ãƒ«)" } },
            y1: {
              type: "linear",
              position: "left",
              title: { display: true, text: "ä½“é‡ (kg)" },
              suggestedMin: 40,
              suggestedMax: 90,
            },
            y2: {
              type: "linear",
              position: "right",
              title: { display: true, text: "ä½“è„‚è‚ªç‡ (%)" },
              suggestedMin: 10,
              suggestedMax: 40,
              grid: { drawOnChartArea: false },
            },
          },
        },
      });

      // ğŸ“¦ LocalStorage çŠ¶æ³æ›´æ–°
      (function initTokenUI() {
        const has = !!localStorage.getItem("idToken");
        document.getElementById("tokenStatus").textContent = has
          ? "âœ… ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ¸ˆã¿"
          : "âŒ ãƒˆãƒ¼ã‚¯ãƒ³æœªä¿å­˜";
        document.getElementById("paste-token").style.display = has
          ? "none"
          : "flex";
      })();

      document.getElementById("showPaste").onclick = () => {
        document.getElementById("paste-token").style.display = "flex";
      };

      document.getElementById("doSavePaste").onclick = () => {
        const t = document.getElementById("token-input").value.trim();
        if (!t) return alert("IdToken ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        localStorage.setItem("idToken", t);
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
        document.getElementById("tokenStatus").textContent = "âœ… ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ¸ˆã¿";
        document.getElementById("paste-token").style.display = "none";
      };

      document.getElementById("clearToken").onclick = () => {
        localStorage.removeItem("idToken");
        alert("æ¶ˆå»ã—ã¾ã—ãŸ");
        document.getElementById("tokenStatus").textContent = "âŒ ãƒˆãƒ¼ã‚¯ãƒ³æœªä¿å­˜";
        document.getElementById("paste-token").style.display = "flex";
      };

      // ğŸ§® ãƒ‡ãƒ¼ã‚¿å–å¾—
      async function fetchAndDraw() {
        try {
          const fromVal = $from.value;
          const fromISO = fromVal
            ? new Date(fromVal).toISOString()
            : "1970-01-01T00:00:00Z";
          const url = `${BASE_URL}/weights?from=${encodeURIComponent(fromISO)}`;
          const res = await fetch(url, { headers: getAuthHeader() });
          const text = await res.text();
          if (!res.ok) throw new Error(`GET å¤±æ•—: ${res.status} ${text}`);
          const json = JSON.parse(text);
          const items = (json.items || []).sort((a, b) =>
            a.loggedAt.localeCompare(b.loggedAt)
          );

          chart.data.labels = items.map((x) => fmtLocal(x.loggedAt));
          chart.data.datasets[0].data = items.map((x) => Number(x.weightKg));
          chart.data.datasets[1].data = items.map((x) =>
            x.bodyFat !== undefined && x.bodyFat !== null
              ? Number(x.bodyFat)
              : null
          );
          chart.update();

          log(
            `GET OK (${items.length}ä»¶)\n` +
              JSON.stringify(items.slice(-5), null, 2)
          );
        } catch (e) {
          console.error(e);
          alert(e.message || e);
          log(e.message || e);
        }
      }

      // â• ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
      async function addWeight() {
        try {
          const input = prompt("ä»Šæ—¥ã®ä½“é‡(kg)ã‚’å…¥åŠ›:", "62.8");
          if (input == null) return;
          const weight = Number(input);
          if (!Number.isFinite(weight)) return alert("æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

          const fatInput = prompt("ä½“è„‚è‚ªç‡(%)ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰:", "20.5");
          const bodyFat = fatInput ? Number(fatInput) : null;

          const res = await fetch(`${BASE_URL}/weights`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeader(),
            },
            body: JSON.stringify({ weightKg: weight, bodyFat }),
          });

          const text = await res.text();
          if (!res.ok) throw new Error(`POST å¤±æ•—: ${res.status} ${text}`);
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
          log(`POST OK\n${text}`);
          await fetchAndDraw();
        } catch (e) {
          console.error(e);
          alert(e.message || e);
          log(e.message || e);
        }
      }

      document.getElementById("load").onclick = fetchAndDraw;
      document.getElementById("add").onclick = addWeight;
    </script>
  </body>
</html>
