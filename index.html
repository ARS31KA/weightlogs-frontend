<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>体重グラフ (WeightLogs)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- BEGIN: Token Receiver (place this at the very top) -->
    <script>
    (function(){
      // 1) URL からトークンを拾う（どちらでもOK：?id_token=... / #id_token=... / ?token=... / #token=...）
      const qs  = new URLSearchParams(location.search);
      const hs  = new URLSearchParams(location.hash.slice(1));
      const tok = qs.get('id_token') || qs.get('token') || hs.get('id_token') || hs.get('token');

      // 2) 受け取れたら localStorage に保存（キーは 'idToken' とする）→ URL をクリーンアップ
      if (tok) {
        localStorage.setItem('idToken', tok);
        try { history.replaceState({}, "", location.pathname + location.search.replace(/(\?|&)id_token=[^&#]*/,'').replace(/(\?|&)token=[^&#]*/,'').replace(/\?$/,'') ); }
        catch(e){}
        // ハッシュも消す
        try { history.replaceState({}, "", location.pathname + location.search); }
        catch(e){}
      }

      // 3) 共通ヘッダを作る関数（未入力なら明確なメッセージ）
      window.getAuthHeader = function(){
        const t = localStorage.getItem('idToken');
        if (!t) throw new Error('IdToken が未入力です（A の認証後に受け取った IdToken を URL で渡すか、このページの入力欄に貼って保存してください）');
        return { Authorization: 'Bearer ' + t };
      };
    })();
    </script>
    <!-- END: Token Receiver -->

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
      body {
        font-family: system-ui, Segoe UI, Helvetica, Arial;
        margin: 24px;
        line-height: 1.6;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }
      input,
      button {
        font-size: 16px;
        padding: 6px 10px;
      }
      canvas {
        max-width: 960px;
        width: 100%;
        height: 360px;
      }
      small {
        color: #555;
      }
      .grow {
        flex: 1 1 360px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
    </style>
  </head>
  <body>
    <h1>体重遷移</h1>

    <!-- （任意）貼り付けUI：指示書にある通り、そのまま追加 -->
    <div id="paste-token" style="display:none;margin:12px 0;">
      <input id="token-input" placeholder="Paste IdToken here" style="width:60%;">
      <button onclick="localStorage.setItem('idToken', document.getElementById('token-input').value.trim()); location.reload();">保存</button>
    </div>
    <script>
      if (!localStorage.getItem('idToken')) document.getElementById('paste-token').style.display='block';
    </script>

    <div class="row">
      <label class="mono">IdToken:</label>
      <input
        id="idToken"
        class="grow"
        placeholder="eyJraWQiOiJYd3U0d092TzlmZVpmT2NqZ0R1M1pvb2owMkFWd2ljZ0F5dFZ1bWhzbGo0PSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiIwNDE4MTQzOC05MGExLTcwYjEtM2MxMy02MjRlNmRlZmY5NjMiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiaXNzIjoiaHR0cHM6XC9cL2NvZ25pdG8taWRwLnVzLWVhc3QtMS5hbWF6b25hd3MuY29tXC91cy1lYXN0LTFfODlsWWhCVEdJIiwiY29nbml0bzp1c2VybmFtZSI6IjA0MTgxNDM4LTkwYTEtNzBiMS0zYzEzLTYyNGU2ZGVmZjk2MyIsIm9yaWdpbl9qdGkiOiI4OTkwOGJkOC00NTE2LTRlY2YtYjMyNi05NjVkM2M2NDZmYTUiLCJhdWQiOiI2djBjYmsyb3Y5bnRsdXE0dGgzYjk3YnZuMCIsImV2ZW50X2lkIjoiZGIxN2NmOTEtZGY1OC00YzQzLWJiMDMtMzUzODVhZWMxZmE2IiwidG9rZW5fdXNlIjoiaWQiLCJhdXRoX3RpbWUiOjE3NjA1MzU2NTcsImV4cCI6MTc2MDYyMjA1NywiaWF0IjoxNzYwNTM1NjU3LCJqdGkiOiIyOWY3MzM5NC03OTAyLTRlMzgtYmQxMS1iMTQwOGFiZDM3NzMiLCJlbWFpbCI6InRlc3QxMDEzQGV4YW1wbGUuY29tIn0.PnWq95FT3PTkj7e-fr_4zVidIl_rhDfZ40L9CZlqHO2gbX89z4w0ekm9PIwC1xLUAyQnA_LOEXdCi1zucM1UZINLlfIO9Yk60bmwlZ3Yj_e9tGNxHg7_A4hJ48v0C9ear0cRJvhOcg-iKSJbqIQ9uVPb128ZCtMjw_S4bbSXFD3DVGruCHx0jleLn76Gx7hAvppWMtNClNnUI9nqjLzakNPesmtNFAGjhaKLekGn2YfHVbX7h_RCM4_Vz2_ZvuJVff1Gt5qeNyY-fEkhBXAW0Y5qpNyWS2vX7vA7V-l2wxHjUt-ZduiKh8BmvhYe2d4mNSbJ06-NhHxoPbtDxLnv1w"
      />
    </div>

    <div class="row">
      <label>期間 from:</label>
      <input id="from" type="datetime-local" />
      <button id="load">読み込み（GET）</button>
      <button id="add">今日の体重を追加（POST）</button>
    </div>

    <small
      >※ トークンは一時的にブラウザの LocalStorage
      に保存します（このPC内のみ）。無効化は「トークン消去」を押してください。</small
    >
    <div class="row" style="margin-top: 8px">
      <button id="saveToken">トークン保存</button>
      <button id="clearToken">トークン消去</button>
    </div>

    <canvas id="chart"></canvas>

    <pre
      id="log"
      style="
        white-space: pre-wrap;
        background: #f7f7f7;
        padding: 8px;
        border-radius: 6px;
        margin-top: 12px;
      "
    ></pre>

    <script>
      // ====== 設定 ======
      const BASE_URL =
        "https://2yn13gve38.execute-api.us-east-1.amazonaws.com/prod";

      // ====== UI要素 ======
      const $token = document.getElementById("idToken");
      const $from = document.getElementById("from");
      const $log = document.getElementById("log");

      // ====== LocalStorage（簡便） ======
      (function restoreToken() {
        const t = localStorage.getItem("idToken");
        if (t) $token.value = t;
      })();

      document.getElementById("saveToken").onclick = () => {
        const t = $token.value.trim();
        if (!t) return alert("IdToken を入力してください");
        localStorage.setItem("idToken", t);
        alert("保存しました");
      };
      document.getElementById("clearToken").onclick = () => {
        localStorage.removeItem("idToken");
        $token.value = "";
        alert("消去しました");
      };

      // ====== Chart.js 初期化 ======
      const ctx = document.getElementById("chart");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{ label: "体重 (kg)", data: [], tension: 0.2 }],
        },
        options: {
          responsive: true,
          interaction: { mode: "nearest", intersect: false },
          scales: {
            x: { title: { display: true, text: "日時 (ローカル)" } },
            y: {
              title: { display: true, text: "kg" },
              suggestedMin: 40,
              suggestedMax: 90,
            },
          },
          plugins: { legend: { display: true } },
        },
      });

      // ISO → ローカル表示
      function fmtLocal(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function log(msg) {
        $log.textContent = String(msg);
      }

      // ※ ここにあった独自の getAuthHeader は削除しました（指示書の window.getAuthHeader を使うため）

      // ====== データ取得 → グラフ描画 ======
      async function fetchAndDraw() {
        try {
          const fromVal = $from.value;
          const fromISO = fromVal
            ? new Date(fromVal).toISOString()
            : "1970-01-01T00:00:00Z";
          const url = `${BASE_URL}/weights?from=${encodeURIComponent(fromISO)}`;

          const res = await fetch(url, { headers: window.getAuthHeader() });
          const text = await res.text();
          if (!res.ok) throw new Error(`GET 失敗: ${res.status} ${text}`);
          const json = JSON.parse(text);
          const items = (json.items || [])
            .slice()
            .sort((a, b) => a.loggedAt.localeCompare(b.loggedAt));

          chart.data.labels = items.map((x) => fmtLocal(x.loggedAt));
          chart.data.datasets[0].data = items.map((x) => Number(x.weightKg));
          chart.update();
          log(
            `GET OK (${items.length}件)\n` +
              JSON.stringify(items.slice(-5), null, 2)
          ); // 末尾5件だけ表示
        } catch (e) {
          console.error(e);
          log(e.message || e);
          alert(e.message || e);
        }
      }

      // ====== 体重を1件追加（POST） ======
      async function addWeight() {
        try {
          const input = prompt("今日の体重(kg)を入力:", "62.8");
          if (input == null) return;
          const weight = Number(input);
          if (!Number.isFinite(weight)) return alert("数値を入力してください");

          const res = await fetch(`${BASE_URL}/weights`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...window.getAuthHeader() },
            body: JSON.stringify({ weightKg: weight }),
          });
          const text = await res.text();
          if (!res.ok) throw new Error(`POST 失敗: ${res.status} ${text}`);
          log(`POST OK\n${text}`);
          await fetchAndDraw();
        } catch (e) {
          console.error(e);
          log(e.message || e);
          alert(e.message || e);
        }
      }

      // イベント
      document.getElementById("load").addEventListener("click", fetchAndDraw);
      document.getElementById("add").addEventListener("click", addWeight);

      // 初期表示（必要ならコメントアウト）
      fetchAndDraw();
    </script>
  </body>
</html>
